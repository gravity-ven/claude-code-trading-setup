<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Cache Prevention -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="max-age=0">
    <meta name="last-modified" content="2025-11-18 00:00:00">
    <meta name="build-version" content="v1.0-ECONOMETRICS-DASHBOARD">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Econometrics Dashboard - Spartan Research Station</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Spartan Theme -->
    <style>
        :root {
            /* Spartan Color Palette */
            --primary-color: #8B0000;        /* Spartan Red */
            --secondary-color: #B22222;      /* Spartan Firebrick */
            --accent-color: #DC143C;         /* Spartan Crimson */
            --accent-2-color: #FF5252;       /* Bright Red */
            --accent-3-color: #FF6B6B;       /* Light Red */
            --bg-dark: #0a1628;              /* Main Background */
            --bg-darker: #050b14;            /* Darker Background */
            --bg-card: #12203a;              /* Card Background */
            --text-primary: #ffffff;         /* White Text */
            --text-secondary: #b0b8c8;       /* Gray Text */
            --text-muted: #7a8a9a;           /* Muted Gray */
            --border-color: #1e3a5f;         /* Border Color */
            --success-color: #00ff88;        /* Success Green */
            --warning-color: #ff9500;        /* Warning Orange */
            --danger-color: #FF5252;         /* Danger Red */
            --info-color: #0096FF;           /* Info Blue */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1700px;
            margin: 0 auto;
        }

        /* Spartan Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--bg-darker));
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color), var(--accent-color));
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header h1 {
            color: var(--accent-color);
            font-size: 2.8rem;
            margin: 0 0 10px 0;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 30px;
            background: var(--accent-color);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
            border: none;
            cursor: pointer;
        }

        .back-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }

        /* Section Styling */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
        }

        .section h2 {
            color: var(--accent-color);
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
        }

        .section h3 {
            color: var(--accent-2-color);
            font-size: 1.4rem;
            margin: 25px 0 15px 0;
            font-weight: 600;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        select, input {
            padding: 10px 15px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            min-width: 150px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(220, 20, 60, 0.1);
        }

        button {
            padding: 10px 25px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: var(--bg-darker);
            border-radius: 8px;
            padding: 15px;
        }

        .chart-container-small {
            position: relative;
            height: 250px;
            margin: 15px 0;
            background: var(--bg-darker);
            border-radius: 8px;
            padding: 15px;
        }

        /* Stats Display */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--bg-darker);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card .stat-value {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-card .stat-subtext {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-darker);
            color: var(--accent-color);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        td {
            color: var(--text-secondary);
        }

        tr:hover {
            background: rgba(220, 20, 60, 0.05);
        }

        /* Matrix Grid */
        .matrix-grid {
            display: grid;
            gap: 2px;
            margin: 20px 0;
            background: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .matrix-cell {
            background: var(--bg-darker);
            padding: 15px;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .matrix-cell:hover {
            background: var(--bg-card);
            transform: scale(1.05);
            z-index: 10;
        }

        .matrix-header {
            background: var(--bg-card);
            color: var(--accent-color);
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Box */
        .results-box {
            background: var(--bg-darker);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--info-color);
        }

        .results-box h4 {
            color: var(--info-color);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .results-box p {
            color: var(--text-secondary);
            margin: 8px 0;
            line-height: 1.8;
        }

        .results-box .highlight {
            color: var(--accent-color);
            font-weight: 700;
        }

        /* Significance Badge */
        .sig-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .sig-badge.significant {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success-color);
        }

        .sig-badge.not-significant {
            background: rgba(255, 149, 0, 0.2);
            color: var(--warning-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-container {
                height: 300px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Info Box */
        .info-box {
            background: rgba(0, 150, 255, 0.1);
            border-left: 4px solid var(--info-color);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 5px 0;
        }

        .info-box strong {
            color: var(--info-color);
        }

        /* Data Status */
        .data-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: var(--bg-darker);
            border-radius: 6px;
            font-size: 0.9rem;
            margin: 10px 0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.loading {
            background: var(--warning-color);
        }

        .status-dot.ready {
            background: var(--success-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üìä ECONOMETRICS DASHBOARD</h1>
            <p>Statistical Analysis & Economic Modeling</p>
            <p style="font-size: 0.95rem; margin-top: 10px;">
                Real-time data from yfinance API ‚Ä¢ FRED Economic Data ‚Ä¢ Advanced Statistical Methods
            </p>
            <a href="index.html" class="back-btn">‚Üê Back to Research Station</a>
        </div>

        <!-- Linear Regression Analysis -->
        <div class="section">
            <h2>üìà Linear Regression Analysis</h2>
            <div class="info-box">
                <p><strong>Purpose:</strong> Analyze linear relationships between two variables and predict values using ordinary least squares (OLS) regression.</p>
                <p><strong>Method:</strong> Calculates slope, intercept, R-squared, correlation, and statistical significance.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>X Variable (Independent)</label>
                    <select id="xVariable">
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="^VIX">VIX (Volatility Index)</option>
                        <option value="DXY">DXY (US Dollar)</option>
                        <option value="GLD">GLD (Gold)</option>
                        <option value="TLT">TLT (20Y Treasury)</option>
                        <option value="IEF">IEF (7-10Y Treasury)</option>
                        <option value="LQD">LQD (Investment Grade Bonds)</option>
                        <option value="HYG">HYG (High Yield Bonds)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Y Variable (Dependent)</label>
                    <select id="yVariable">
                        <option value="TLT">TLT (20Y Treasury)</option>
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="GLD">GLD (Gold)</option>
                        <option value="IEF">IEF (7-10Y Treasury)</option>
                        <option value="^VIX">VIX (Volatility Index)</option>
                        <option value="DXY">DXY (US Dollar)</option>
                        <option value="LQD">LQD (Investment Grade Bonds)</option>
                        <option value="HYG">HYG (High Yield Bonds)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Period</label>
                    <select id="regressionPeriod">
                        <option value="1y">1 Year</option>
                        <option value="2y">2 Years</option>
                        <option value="3y" selected>3 Years</option>
                        <option value="5y">5 Years</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="runRegression()">Run Regression</button>
                </div>
            </div>

            <div class="data-status" id="regressionStatus" style="display: none;">
                <div class="status-dot loading"></div>
                <span>Loading data...</span>
            </div>

            <div class="chart-container">
                <canvas id="regressionChart"></canvas>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Equation</div>
                    <div class="stat-value" style="font-size: 1.2rem;" id="equation">y = mx + b</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">R-Squared</div>
                    <div class="stat-value" id="rsquared">0.0000</div>
                    <div class="stat-subtext">Goodness of fit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Correlation</div>
                    <div class="stat-value" id="correlation">0.0000</div>
                    <div class="stat-subtext">Strength of relationship</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">P-Value</div>
                    <div class="stat-value" id="pvalue">0.0000</div>
                    <div class="stat-subtext">Statistical significance</div>
                </div>
            </div>
        </div>

        <!-- Time Series Decomposition -->
        <div class="section">
            <h2>üîÑ Time Series Decomposition</h2>
            <div class="info-box">
                <p><strong>Purpose:</strong> Separate time series data into trend, seasonal, and residual components.</p>
                <p><strong>Method:</strong> Additive decomposition using moving averages for trend extraction.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Asset</label>
                    <select id="decomposeAsset">
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="GLD">GLD (Gold)</option>
                        <option value="TLT">TLT (20Y Treasury)</option>
                        <option value="IEF">IEF (7-10Y Treasury)</option>
                        <option value="DXY">DXY (US Dollar)</option>
                        <option value="^VIX">VIX (Volatility Index)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Period</label>
                    <select id="decomposePeriod">
                        <option value="21">21 Days (Monthly)</option>
                        <option value="63">63 Days (Quarterly)</option>
                        <option value="126">126 Days (Semi-Annual)</option>
                        <option value="252">252 Days (Annual)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="decomposeSeries()">Decompose Series</button>
                </div>
            </div>

            <div class="data-status" id="decomposeStatus" style="display: none;">
                <div class="status-dot loading"></div>
                <span>Decomposing time series...</span>
            </div>

            <h3>Original Series</h3>
            <div class="chart-container-small">
                <canvas id="originalChart"></canvas>
            </div>

            <h3>Trend Component</h3>
            <div class="chart-container-small">
                <canvas id="trendChart"></canvas>
            </div>

            <h3>Seasonal Component</h3>
            <div class="chart-container-small">
                <canvas id="seasonalChart"></canvas>
            </div>

            <h3>Residual Component</h3>
            <div class="chart-container-small">
                <canvas id="residualChart"></canvas>
            </div>
        </div>

        <!-- Correlation Matrix -->
        <div class="section">
            <h2>üîó Correlation Matrix</h2>
            <div class="info-box">
                <p><strong>Purpose:</strong> Calculate pairwise correlations between multiple assets to identify relationships.</p>
                <p><strong>Method:</strong> Pearson correlation coefficient with statistical significance testing.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Period</label>
                    <select id="correlationPeriod">
                        <option value="1y">1 Year</option>
                        <option value="2y" selected>2 Years</option>
                        <option value="3y">3 Years</option>
                        <option value="5y">5 Years</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="calculateCorrelationMatrix()">Calculate Matrix</button>
                </div>
            </div>

            <div class="data-status" id="correlationStatus" style="display: none;">
                <div class="status-dot loading"></div>
                <span>Calculating correlations...</span>
            </div>

            <div id="correlationMatrixDisplay"></div>
            <div id="significanceTests"></div>
        </div>

        <!-- Cointegration Testing -->
        <div class="section">
            <h2>‚öñÔ∏è Cointegration Analysis</h2>
            <div class="info-box">
                <p><strong>Purpose:</strong> Test for long-term equilibrium relationships between asset pairs (essential for pairs trading).</p>
                <p><strong>Method:</strong> Engle-Granger two-step cointegration test with ADF unit root test on residuals.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Asset 1</label>
                    <select id="pair1">
                        <option value="GLD">GLD (Gold ETF)</option>
                        <option value="GDX">GDX (Gold Miners)</option>
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="IWM">IWM (Russell 2000)</option>
                        <option value="XLE">XLE (Energy Sector)</option>
                        <option value="XLF">XLF (Financial Sector)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Asset 2</label>
                    <select id="pair2">
                        <option value="GDX">GDX (Gold Miners)</option>
                        <option value="GLD">GLD (Gold ETF)</option>
                        <option value="IWM">IWM (Russell 2000)</option>
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="XLF">XLF (Financial Sector)</option>
                        <option value="XLE">XLE (Energy Sector)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Period</label>
                    <select id="cointegrationPeriod">
                        <option value="2y" selected>2 Years</option>
                        <option value="3y">3 Years</option>
                        <option value="5y">5 Years</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="testCointegration()">Test Cointegration</button>
                </div>
            </div>

            <div class="data-status" id="cointegrationStatus" style="display: none;">
                <div class="status-dot loading"></div>
                <span>Running cointegration test...</span>
            </div>

            <div id="cointegrationResults"></div>

            <div class="chart-container">
                <canvas id="cointegrationChart"></canvas>
            </div>
        </div>

        <!-- Statistical Summary -->
        <div class="section">
            <h2>üìä Statistical Summary</h2>
            <div class="info-box">
                <p><strong>Purpose:</strong> Comprehensive statistical analysis including distribution properties and risk metrics.</p>
                <p><strong>Metrics:</strong> Returns, volatility, Sharpe ratio, skewness, kurtosis, and maximum drawdown.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Asset</label>
                    <select id="summaryAsset">
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="QQQ">QQQ (NASDAQ 100)</option>
                        <option value="IWM">IWM (Russell 2000)</option>
                        <option value="GLD">GLD (Gold)</option>
                        <option value="TLT">TLT (20Y Treasury)</option>
                        <option value="^VIX">VIX (Volatility Index)</option>
                        <option value="DXY">DXY (US Dollar)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Period</label>
                    <select id="summaryPeriod">
                        <option value="1y">1 Year</option>
                        <option value="2y">2 Years</option>
                        <option value="3y" selected>3 Years</option>
                        <option value="5y">5 Years</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="calculateSummary()">Calculate Statistics</button>
                </div>
            </div>

            <div class="data-status" id="summaryStatus" style="display: none;">
                <div class="status-dot loading"></div>
                <span>Calculating statistics...</span>
            </div>

            <table id="summaryTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Annualized Return</td>
                        <td id="mean">-</td>
                        <td>Average return per year</td>
                    </tr>
                    <tr>
                        <td>Annualized Volatility</td>
                        <td id="std">-</td>
                        <td>Standard deviation of returns</td>
                    </tr>
                    <tr>
                        <td>Sharpe Ratio</td>
                        <td id="sharpe">-</td>
                        <td>Risk-adjusted return (rf=2%)</td>
                    </tr>
                    <tr>
                        <td>Skewness</td>
                        <td id="skew">-</td>
                        <td>Asymmetry of return distribution</td>
                    </tr>
                    <tr>
                        <td>Excess Kurtosis</td>
                        <td id="kurt">-</td>
                        <td>Tail risk (0=normal distribution)</td>
                    </tr>
                    <tr>
                        <td>Maximum Drawdown</td>
                        <td id="maxdd">-</td>
                        <td>Largest peak-to-trough decline</td>
                    </tr>
                    <tr>
                        <td>Calmar Ratio</td>
                        <td id="calmar">-</td>
                        <td>Return / Max Drawdown</td>
                    </tr>
                    <tr>
                        <td>Value at Risk (95%)</td>
                        <td id="var95">-</td>
                        <td>Daily VaR at 95% confidence</td>
                    </tr>
                </tbody>
            </table>

            <div class="chart-container" id="returnsDistChart" style="display: none;">
                <canvas id="returnsDistribution"></canvas>
            </div>
        </div>

        <!-- Granger Causality -->
        <div class="section">
            <h2>üéØ Granger Causality Test</h2>
            <div class="info-box">
                <p><strong>Purpose:</strong> Test whether one time series is useful for forecasting another.</p>
                <p><strong>Interpretation:</strong> "X Granger-causes Y" means past values of X provide statistically significant information about future values of Y.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Cause Variable (X)</label>
                    <select id="causeVar">
                        <option value="^VIX">VIX (Volatility)</option>
                        <option value="DXY">DXY (US Dollar)</option>
                        <option value="TLT">TLT (Bonds)</option>
                        <option value="GLD">GLD (Gold)</option>
                        <option value="SPY">SPY (S&P 500)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Effect Variable (Y)</label>
                    <select id="effectVar">
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="GLD">GLD (Gold)</option>
                        <option value="TLT">TLT (Bonds)</option>
                        <option value="^VIX">VIX (Volatility)</option>
                        <option value="DXY">DXY (US Dollar)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Max Lags</label>
                    <select id="maxLags">
                        <option value="5">5 Days</option>
                        <option value="10" selected>10 Days</option>
                        <option value="20">20 Days</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="testGrangerCausality()">Test Causality</button>
                </div>
            </div>

            <div class="data-status" id="grangerStatus" style="display: none;">
                <div class="status-dot loading"></div>
                <span>Testing Granger causality...</span>
            </div>

            <div id="grangerResults"></div>
        </div>
    </div>

    <script>
        // Configuration
        const FRED_API_KEY = '0a08e7a69f8dbd1b02e19e7af5a82b61';

        // Chart instances
        let charts = {
            regression: null,
            original: null,
            trend: null,
            seasonal: null,
            residual: null,
            cointegration: null,
            returnsDistribution: null
        };

        // ==================== DATA FETCHING ====================

        async function fetchYahooData(symbol, period = '2y') {
            try {
                // Use Yahoo Finance CSV download API (no key required, unlimited)
                const periodMap = { '1y': '1y', '2y': '2y', '3y': '3y', '5y': '5y', '10y': '10y' };
                const periodValue = periodMap[period] || '2y';

                // Calculate date range
                const endDate = new Date();
                const startDate = new Date();
                const yearDiff = parseInt(periodValue);
                startDate.setFullYear(startDate.getFullYear() - yearDiff);

                const start = Math.floor(startDate.getTime() / 1000);
                const end = Math.floor(endDate.getTime() / 1000);

                // Yahoo Finance CSV API
                const url = `http://localhost:5002/api/yahoo/v7/finance/download/${symbol}?period1=${start}&period2=${end}&interval=1d&events=history`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Data fetch failed');

                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                const data = [];

                // Parse CSV (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 6 && parts[4] !== 'null') {
                        data.push({
                            date: parts[0],
                            close: parseFloat(parts[4])
                        });
                    }
                }

                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                // Fallback: generate realistic synthetic data based on historical patterns
                return generateFallbackData(symbol, period);
            }
        }

        function generateFallbackData(symbol, period) {
            // NO FAKE DATA POLICY: Return empty array instead of synthetic data
            // If real data API fails, user should see error, not fabricated data
            console.error(`‚ùå NO DATA AVAILABLE for ${symbol} (${period}). API failed and fake data is forbidden.`);
            console.error('Please check API connection or try again later.');
            return [];
        }

        // ==================== STATISTICAL FUNCTIONS ====================

        function linearRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // R-squared
            const yMean = sumY / n;
            const ssTotal = y.reduce((sum, yi) => sum + Math.pow(yi - yMean, 2), 0);
            const ssResidual = y.reduce((sum, yi, i) => {
                const predicted = slope * x[i] + intercept;
                return sum + Math.pow(yi - predicted, 2);
            }, 0);
            const rSquared = 1 - (ssResidual / ssTotal);

            // Correlation
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            const correlation = numerator / denominator;

            // T-statistic and p-value
            const se = Math.sqrt(ssResidual / (n - 2));
            const sx = Math.sqrt(sumX2 / n - Math.pow(sumX / n, 2));
            const tStat = Math.abs(correlation) * Math.sqrt((n - 2) / (1 - rSquared));
            const pValue = 2 * (1 - tDistributionCDF(tStat, n - 2));

            return { slope, intercept, rSquared, correlation, pValue };
        }

        function tDistributionCDF(t, df) {
            // Approximation of t-distribution CDF
            const x = df / (df + t * t);
            return 1 - 0.5 * betaIncomplete(df / 2, 0.5, x);
        }

        function betaIncomplete(a, b, x) {
            // Simplified incomplete beta function approximation
            if (x === 0) return 0;
            if (x === 1) return 1;
            // Use normal approximation for large values
            return 0.5 * (1 + erf((x - 0.5) / 0.29));
        }

        function erf(x) {
            // Approximation of error function
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            return sign * y;
        }

        function calculateMovingAverage(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j];
                    }
                    result.push(sum / period);
                }
            }
            return result;
        }

        function decomposeTimeSeries(data, period) {
            // Trend component (centered moving average)
            const trend = calculateMovingAverage(data, period);

            // Detrended data
            const detrended = data.map((val, i) => trend[i] ? val - trend[i] : null);

            // Seasonal component (average by period position)
            const seasonalAvg = new Array(period).fill(0);
            const seasonalCount = new Array(period).fill(0);

            detrended.forEach((val, i) => {
                if (val !== null) {
                    seasonalAvg[i % period] += val;
                    seasonalCount[i % period]++;
                }
            });

            const seasonal = seasonalAvg.map((sum, i) =>
                seasonalCount[i] > 0 ? sum / seasonalCount[i] : 0
            );

            // Normalize seasonal component (mean = 0)
            const seasonalMean = seasonal.reduce((a, b) => a + b, 0) / seasonal.length;
            const normalizedSeasonal = seasonal.map(val => val - seasonalMean);

            // Residual component
            const residual = data.map((val, i) => {
                if (trend[i]) {
                    return val - trend[i] - normalizedSeasonal[i % period];
                }
                return null;
            });

            return {
                trend,
                seasonal: data.map((_, i) => normalizedSeasonal[i % period]),
                residual
            };
        }

        function pearsonCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return numerator / denominator;
        }

        function calculateReturns(prices) {
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push((prices[i] - prices[i - 1]) / prices[i - 1]);
            }
            return returns;
        }

        function calculateStatistics(returns) {
            const n = returns.length;
            const mean = returns.reduce((a, b) => a + b, 0) / n;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / n;
            const std = Math.sqrt(variance);

            // Annualized metrics
            const annualizedReturn = mean * 252;
            const annualizedVol = std * Math.sqrt(252);

            // Sharpe ratio (assuming 2% risk-free rate)
            const sharpe = (annualizedReturn - 0.02) / annualizedVol;

            // Skewness
            const skew = returns.reduce((sum, r) => sum + Math.pow((r - mean) / std, 3), 0) / n;

            // Excess kurtosis
            const kurt = returns.reduce((sum, r) => sum + Math.pow((r - mean) / std, 4), 0) / n - 3;

            // VaR 95%
            const sortedReturns = [...returns].sort((a, b) => a - b);
            const var95Index = Math.floor(n * 0.05);
            const var95 = sortedReturns[var95Index];

            return {
                mean: annualizedReturn,
                std: annualizedVol,
                sharpe,
                skew,
                kurt,
                var95
            };
        }

        function calculateMaxDrawdown(prices) {
            let maxDD = 0;
            let peak = prices[0];

            for (let i = 1; i < prices.length; i++) {
                if (prices[i] > peak) {
                    peak = prices[i];
                }
                const drawdown = (peak - prices[i]) / peak;
                if (drawdown > maxDD) {
                    maxDD = drawdown;
                }
            }

            return maxDD;
        }

        function adfTest(series) {
            // Simplified Augmented Dickey-Fuller test
            // Returns test statistic (more negative = more stationary)
            const n = series.length;
            const diffs = [];
            for (let i = 1; i < n; i++) {
                diffs.push(series[i] - series[i - 1]);
            }

            const laggedSeries = series.slice(0, -1);
            const regression = linearRegression(laggedSeries, diffs);

            // Test statistic approximation
            const tStat = regression.slope / Math.sqrt(regression.rSquared / n);

            return tStat;
        }

        // ==================== REGRESSION ANALYSIS ====================

        async function runRegression() {
            const xVar = document.getElementById('xVariable').value;
            const yVar = document.getElementById('yVariable').value;
            const period = document.getElementById('regressionPeriod').value;

            const status = document.getElementById('regressionStatus');
            status.style.display = 'flex';

            try {
                // Fetch data
                const [xData, yData] = await Promise.all([
                    fetchYahooData(xVar, period),
                    fetchYahooData(yVar, period)
                ]);

                // Align data by date
                const aligned = alignDataByDate(xData, yData);
                const xPrices = aligned.x.map(d => d.close);
                const yPrices = aligned.y.map(d => d.close);

                // Run regression
                const result = linearRegression(xPrices, yPrices);

                // Update stats
                document.getElementById('equation').textContent =
                    `y = ${result.slope.toFixed(4)}x + ${result.intercept.toFixed(4)}`;
                document.getElementById('rsquared').textContent = result.rSquared.toFixed(4);
                document.getElementById('correlation').textContent = result.correlation.toFixed(4);
                document.getElementById('pvalue').textContent = result.pValue.toFixed(6);

                // Create regression line
                const xMin = Math.min(...xPrices);
                const xMax = Math.max(...xPrices);
                const regressionLine = [
                    { x: xMin, y: result.slope * xMin + result.intercept },
                    { x: xMax, y: result.slope * xMax + result.intercept }
                ];

                // Plot
                plotRegression(xPrices, yPrices, regressionLine, xVar, yVar);

                status.style.display = 'none';
            } catch (error) {
                console.error('Regression error:', error);
                status.innerHTML = '<div class="status-dot" style="background: var(--danger-color);"></div><span>Error loading data</span>';
            }
        }

        function alignDataByDate(data1, data2) {
            const dateMap1 = new Map(data1.map(d => [d.date, d]));
            const dateMap2 = new Map(data2.map(d => [d.date, d]));

            const commonDates = [...dateMap1.keys()].filter(date => dateMap2.has(date));

            return {
                x: commonDates.map(date => dateMap1.get(date)),
                y: commonDates.map(date => dateMap2.get(date))
            };
        }

        function plotRegression(xData, yData, regressionLine, xLabel, yLabel) {
            const ctx = document.getElementById('regressionChart').getContext('2d');

            if (charts.regression) {
                charts.regression.destroy();
            }

            charts.regression = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Data Points',
                        data: xData.map((x, i) => ({ x, y: yData[i] })),
                        backgroundColor: 'rgba(220, 20, 60, 0.5)',
                        borderColor: 'rgba(220, 20, 60, 0.8)',
                        pointRadius: 3
                    }, {
                        label: 'Regression Line',
                        data: regressionLine,
                        type: 'line',
                        borderColor: '#00ff88',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#b0b8c8' }
                        },
                        title: {
                            display: true,
                            text: `${xLabel} vs ${yLabel}`,
                            color: '#DC143C'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: xLabel, color: '#b0b8c8' },
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        },
                        y: {
                            title: { display: true, text: yLabel, color: '#b0b8c8' },
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });
        }

        // ==================== TIME SERIES DECOMPOSITION ====================

        async function decomposeSeries() {
            const asset = document.getElementById('decomposeAsset').value;
            const period = parseInt(document.getElementById('decomposePeriod').value);

            const status = document.getElementById('decomposeStatus');
            status.style.display = 'flex';

            try {
                const data = await fetchYahooData(asset, '3y');
                const prices = data.map(d => d.close);
                const dates = data.map(d => d.date);

                const decomposition = decomposeTimeSeries(prices, period);

                plotTimeSeries(dates, prices, 'originalChart', 'Original Series', asset);
                plotTimeSeries(dates, decomposition.trend, 'trendChart', 'Trend Component', asset);
                plotTimeSeries(dates, decomposition.seasonal, 'seasonalChart', 'Seasonal Component', asset);
                plotTimeSeries(dates, decomposition.residual, 'residualChart', 'Residual Component', asset);

                status.style.display = 'none';
            } catch (error) {
                console.error('Decomposition error:', error);
                status.innerHTML = '<div class="status-dot" style="background: var(--danger-color);"></div><span>Error loading data</span>';
            }
        }

        function plotTimeSeries(dates, values, canvasId, title, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chartKey = canvasId.replace('Chart', '');

            if (charts[chartKey]) {
                charts[chartKey].destroy();
            }

            const filteredData = dates.map((date, i) => ({
                x: date,
                y: values[i]
            })).filter(d => d.y !== null);

            charts[chartKey] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: label,
                        data: filteredData,
                        borderColor: '#DC143C',
                        backgroundColor: 'rgba(220, 20, 60, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: title,
                            color: '#DC143C'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        },
                        y: {
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });
        }

        // ==================== CORRELATION MATRIX ====================

        async function calculateCorrelationMatrix() {
            const period = document.getElementById('correlationPeriod').value;
            const status = document.getElementById('correlationStatus');
            status.style.display = 'flex';

            const assets = ['SPY', 'QQQ', 'IWM', 'GLD', 'TLT', 'DXY', '^VIX'];

            try {
                // Fetch all data
                const allData = await Promise.all(assets.map(asset => fetchYahooData(asset, period)));

                // Calculate returns
                const returns = allData.map(data => calculateReturns(data.map(d => d.close)));

                // Calculate correlation matrix
                const n = assets.length;
                const matrix = Array(n).fill(0).map(() => Array(n).fill(0));

                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        if (i === j) {
                            matrix[i][j] = 1.0;
                        } else {
                            const minLen = Math.min(returns[i].length, returns[j].length);
                            matrix[i][j] = pearsonCorrelation(
                                returns[i].slice(0, minLen),
                                returns[j].slice(0, minLen)
                            );
                        }
                    }
                }

                displayCorrelationMatrix(assets, matrix);
                status.style.display = 'none';
            } catch (error) {
                console.error('Correlation error:', error);
                status.innerHTML = '<div class="status-dot" style="background: var(--danger-color);"></div><span>Error loading data</span>';
            }
        }

        function displayCorrelationMatrix(assets, matrix) {
            const container = document.getElementById('correlationMatrixDisplay');
            const n = assets.length;

            let html = '<div class="matrix-grid" style="grid-template-columns: repeat(' + (n + 1) + ', 1fr);">';

            // Header row
            html += '<div class="matrix-cell matrix-header"></div>';
            assets.forEach(asset => {
                html += `<div class="matrix-cell matrix-header">${asset}</div>`;
            });

            // Data rows
            for (let i = 0; i < n; i++) {
                html += `<div class="matrix-cell matrix-header">${assets[i]}</div>`;
                for (let j = 0; j < n; j++) {
                    const corr = matrix[i][j];
                    const color = getCorrelationColor(corr);
                    html += `<div class="matrix-cell" style="background: ${color}; color: #fff; font-weight: 700;">
                        ${corr.toFixed(2)}
                    </div>`;
                }
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getCorrelationColor(corr) {
            // Red (negative) to Green (positive)
            if (corr > 0) {
                const intensity = Math.floor(corr * 200);
                return `rgba(0, 255, 136, ${corr * 0.7})`;
            } else {
                const intensity = Math.floor(Math.abs(corr) * 200);
                return `rgba(220, 20, 60, ${Math.abs(corr) * 0.7})`;
            }
        }

        // ==================== COINTEGRATION TEST ====================

        async function testCointegration() {
            const asset1 = document.getElementById('pair1').value;
            const asset2 = document.getElementById('pair2').value;
            const period = document.getElementById('cointegrationPeriod').value;

            const status = document.getElementById('cointegrationStatus');
            status.style.display = 'flex';

            try {
                const [data1, data2] = await Promise.all([
                    fetchYahooData(asset1, period),
                    fetchYahooData(asset2, period)
                ]);

                const aligned = alignDataByDate(data1, data2);
                const prices1 = aligned.x.map(d => d.close);
                const prices2 = aligned.y.map(d => d.close);

                // Step 1: Run regression
                const regression = linearRegression(prices1, prices2);

                // Step 2: Calculate residuals
                const residuals = prices2.map((y, i) =>
                    y - (regression.slope * prices1[i] + regression.intercept)
                );

                // Step 3: ADF test on residuals
                const adfStat = adfTest(residuals);

                // Critical values (approximation)
                const criticalValues = { '1%': -3.90, '5%': -3.34, '10%': -3.04 };
                const isCointegrated = adfStat < criticalValues['5%'];

                // Display results
                const resultsDiv = document.getElementById('cointegrationResults');
                resultsDiv.innerHTML = `
                    <div class="results-box">
                        <h4>Cointegration Test Results</h4>
                        <p><strong>Asset Pair:</strong> ${asset1} vs ${asset2}</p>
                        <p><strong>Regression Equation:</strong> ${asset2} = ${regression.slope.toFixed(4)} √ó ${asset1} + ${regression.intercept.toFixed(4)}</p>
                        <p><strong>R-Squared:</strong> ${regression.rSquared.toFixed(4)}</p>
                        <p><strong>ADF Test Statistic:</strong> <span class="highlight">${adfStat.toFixed(4)}</span></p>
                        <p><strong>Critical Values:</strong> 1%=${criticalValues['1%']}, 5%=${criticalValues['5%']}, 10%=${criticalValues['10%']}</p>
                        <p><strong>Result:</strong> ${isCointegrated ?
                            '<span style="color: var(--success-color); font-weight: 700;">‚úì Cointegrated (stationary residuals)</span>' :
                            '<span style="color: var(--warning-color); font-weight: 700;">‚úó Not Cointegrated</span>'}</p>
                        <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                            ${isCointegrated ?
                                'These assets have a long-term equilibrium relationship. Suitable for pairs trading strategies.' :
                                'No evidence of long-term equilibrium. Pairs trading may be risky.'}
                        </p>
                    </div>
                `;

                // Plot spread
                plotSpread(aligned.x.map(d => d.date), residuals, asset1, asset2);

                status.style.display = 'none';
            } catch (error) {
                console.error('Cointegration error:', error);
                status.innerHTML = '<div class="status-dot" style="background: var(--danger-color);"></div><span>Error loading data</span>';
            }
        }

        function plotSpread(dates, residuals, asset1, asset2) {
            const ctx = document.getElementById('cointegrationChart').getContext('2d');

            if (charts.cointegration) {
                charts.cointegration.destroy();
            }

            const mean = residuals.reduce((a, b) => a + b, 0) / residuals.length;
            const std = Math.sqrt(residuals.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / residuals.length);

            charts.cointegration = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Spread (Residuals)',
                        data: residuals,
                        borderColor: '#DC143C',
                        backgroundColor: 'rgba(220, 20, 60, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }, {
                        label: 'Mean',
                        data: new Array(dates.length).fill(mean),
                        borderColor: '#00ff88',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: '+2 Std Dev',
                        data: new Array(dates.length).fill(mean + 2 * std),
                        borderColor: '#ff9500',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: '-2 Std Dev',
                        data: new Array(dates.length).fill(mean - 2 * std),
                        borderColor: '#ff9500',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#b0b8c8' }
                        },
                        title: {
                            display: true,
                            text: `Cointegration Spread: ${asset1} vs ${asset2}`,
                            color: '#DC143C'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        },
                        y: {
                            title: { display: true, text: 'Spread', color: '#b0b8c8' },
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });
        }

        // ==================== STATISTICAL SUMMARY ====================

        async function calculateSummary() {
            const asset = document.getElementById('summaryAsset').value;
            const period = document.getElementById('summaryPeriod').value;

            const status = document.getElementById('summaryStatus');
            status.style.display = 'flex';

            try {
                const data = await fetchYahooData(asset, period);
                const prices = data.map(d => d.close);
                const returns = calculateReturns(prices);

                const stats = calculateStatistics(returns);
                const maxDD = calculateMaxDrawdown(prices);
                const calmar = stats.mean / maxDD;

                // Update table
                document.getElementById('mean').textContent = (stats.mean * 100).toFixed(2) + '%';
                document.getElementById('std').textContent = (stats.std * 100).toFixed(2) + '%';
                document.getElementById('sharpe').textContent = stats.sharpe.toFixed(2);
                document.getElementById('skew').textContent = stats.skew.toFixed(2);
                document.getElementById('kurt').textContent = stats.kurt.toFixed(2);
                document.getElementById('maxdd').textContent = (maxDD * 100).toFixed(2) + '%';
                document.getElementById('calmar').textContent = calmar.toFixed(2);
                document.getElementById('var95').textContent = (stats.var95 * 100).toFixed(2) + '%';

                document.getElementById('summaryTable').style.display = 'table';
                document.getElementById('returnsDistChart').style.display = 'block';

                // Plot returns distribution
                plotReturnsDistribution(returns, asset);

                status.style.display = 'none';
            } catch (error) {
                console.error('Summary error:', error);
                status.innerHTML = '<div class="status-dot" style="background: var(--danger-color);"></div><span>Error loading data</span>';
            }
        }

        function plotReturnsDistribution(returns, asset) {
            const ctx = document.getElementById('returnsDistribution').getContext('2d');

            if (charts.returnsDistribution) {
                charts.returnsDistribution.destroy();
            }

            // Create histogram
            const bins = 50;
            const min = Math.min(...returns);
            const max = Math.max(...returns);
            const binWidth = (max - min) / bins;

            const histogram = new Array(bins).fill(0);
            const binLabels = [];

            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                binLabels.push((binStart * 100).toFixed(2));
            }

            returns.forEach(r => {
                const binIndex = Math.min(Math.floor((r - min) / binWidth), bins - 1);
                histogram[binIndex]++;
            });

            charts.returnsDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Frequency',
                        data: histogram,
                        backgroundColor: 'rgba(220, 20, 60, 0.7)',
                        borderColor: '#DC143C',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Returns Distribution - ${asset}`,
                            color: '#DC143C'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Daily Return (%)', color: '#b0b8c8' },
                            ticks: {
                                color: '#7a8a9a',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#1e3a5f' }
                        },
                        y: {
                            title: { display: true, text: 'Frequency', color: '#b0b8c8' },
                            ticks: { color: '#7a8a9a' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });
        }

        // ==================== GRANGER CAUSALITY ====================

        async function testGrangerCausality() {
            const causeVar = document.getElementById('causeVar').value;
            const effectVar = document.getElementById('effectVar').value;
            const maxLags = parseInt(document.getElementById('maxLags').value);

            const status = document.getElementById('grangerStatus');
            status.style.display = 'flex';

            try {
                const [causeData, effectData] = await Promise.all([
                    fetchYahooData(causeVar, '2y'),
                    fetchYahooData(effectVar, '2y')
                ]);

                const aligned = alignDataByDate(causeData, effectData);
                const causePrices = aligned.x.map(d => d.close);
                const effectPrices = aligned.y.map(d => d.close);

                const causeReturns = calculateReturns(causePrices);
                const effectReturns = calculateReturns(effectPrices);

                // Simplified Granger causality test
                const results = [];

                for (let lag = 1; lag <= maxLags; lag++) {
                    // Restricted model: Y_t = Œ± + Œ≤*Y_{t-lag} + Œµ
                    const yLagged = effectReturns.slice(0, -lag);
                    const yCurrent = effectReturns.slice(lag);
                    const restrictedModel = linearRegression(yLagged, yCurrent);
                    const rssRestricted = calculateRSS(yLagged, yCurrent, restrictedModel);

                    // Unrestricted model: Y_t = Œ± + Œ≤*Y_{t-lag} + Œ≥*X_{t-lag} + Œµ
                    // Approximate using multiple regression (simplified)
                    const xLagged = causeReturns.slice(0, -lag);
                    const unrestrictedR2 = Math.max(
                        restrictedModel.rSquared,
                        pearsonCorrelation(xLagged.slice(0, Math.min(xLagged.length, yCurrent.length)),
                                          yCurrent.slice(0, Math.min(xLagged.length, yCurrent.length))) ** 2
                    );
                    const rssUnrestricted = calculateRSS(yLagged, yCurrent, {
                        ...restrictedModel,
                        rSquared: unrestrictedR2
                    });

                    // F-statistic
                    const fStat = ((rssRestricted - rssUnrestricted) / lag) /
                                 (rssUnrestricted / (yCurrent.length - 2 * lag - 1));

                    // Approximate p-value
                    const pValue = 1 - fDistributionCDF(fStat, lag, yCurrent.length - 2 * lag - 1);

                    results.push({ lag, fStat, pValue });
                }

                // Display results
                const resultsDiv = document.getElementById('grangerResults');
                let html = '<div class="results-box"><h4>Granger Causality Test Results</h4>';
                html += `<p><strong>Null Hypothesis:</strong> ${causeVar} does NOT Granger-cause ${effectVar}</p>`;
                html += '<table style="margin-top: 15px;"><thead><tr><th>Lag</th><th>F-Statistic</th><th>P-Value</th><th>Result</th></tr></thead><tbody>';

                results.forEach(r => {
                    const significant = r.pValue < 0.05;
                    html += `<tr>
                        <td>${r.lag}</td>
                        <td>${r.fStat.toFixed(4)}</td>
                        <td>${r.pValue.toFixed(4)}</td>
                        <td>${significant ?
                            '<span class="sig-badge significant">Reject H0</span>' :
                            '<span class="sig-badge not-significant">Fail to Reject</span>'}</td>
                    </tr>`;
                });

                html += '</tbody></table>';

                const overallSignificant = results.some(r => r.pValue < 0.05);
                html += `<p style="margin-top: 15px; font-size: 0.9rem;">
                    <strong>Conclusion:</strong> ${overallSignificant ?
                        `<span style="color: var(--success-color);">${causeVar} does Granger-cause ${effectVar} (statistically significant at some lags)</span>` :
                        `<span style="color: var(--text-muted);">No strong evidence that ${causeVar} Granger-causes ${effectVar}</span>`}
                </p></div>`;

                resultsDiv.innerHTML = html;
                status.style.display = 'none';
            } catch (error) {
                console.error('Granger causality error:', error);
                status.innerHTML = '<div class="status-dot" style="background: var(--danger-color);"></div><span>Error loading data</span>';
            }
        }

        function calculateRSS(x, y, model) {
            let rss = 0;
            for (let i = 0; i < Math.min(x.length, y.length); i++) {
                const predicted = model.slope * x[i] + model.intercept;
                rss += Math.pow(y[i] - predicted, 2);
            }
            return rss;
        }

        function fDistributionCDF(f, d1, d2) {
            // Simplified F-distribution CDF approximation
            if (f <= 0) return 0;
            const x = d2 / (d2 + d1 * f);
            return 1 - betaIncomplete(d2 / 2, d1 / 2, x);
        }

        // Initialize
        console.log('Econometrics Dashboard loaded successfully');
        console.log('Data sources: Yahoo Finance (unlimited), FRED API');
    </script>
</body>
</html>
