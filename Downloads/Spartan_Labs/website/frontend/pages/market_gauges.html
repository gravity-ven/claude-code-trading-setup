<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Cache Prevention -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="max-age=0">
    <meta name="last-modified" content="2025-11-18 00:00:00">
    <meta name="build-version" content="v1.0-MARKET-GAUGES-FUNCTIONAL">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spartan Research Station - Market Gauges</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="spartan_theme.css">

    <style>
        :root {
            /* Spartan Color Palette */
            --primary-color: #8B0000;
            --secondary-color: #B22222;
            --accent-color: #DC143C;
            --accent-2-color: #FF5252;
            --accent-3-color: #FF6B6B;
            --bg-dark: #0a1628;
            --bg-darker: #050b14;
            --bg-card: #12203a;
            --text-primary: #ffffff;
            --text-secondary: #b0b8c8;
            --text-muted: #7a8a9a;
            --border-color: #1e3a5f;
            --success-color: #00ff88;
            --warning-color: #ff9500;
            --danger-color: #FF5252;
            --info-color: #0096FF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1700px;
            margin: 0 auto;
        }

        /* Spartan Navigation */
        .spartan-nav {
            background: var(--bg-darker);
            border-bottom: 2px solid var(--accent-color);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
            margin: -20px -20px 20px -20px;
        }

        .nav-container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-logo {
            height: 35px;
            width: auto;
            filter: brightness(1.1);
        }

        .nav-title {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 1.4rem;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        .nav-title:hover {
            color: var(--accent-color);
        }

        .nav-center {
            display: flex;
            align-items: center;
        }

        .nav-item {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 16px;
            border: 1px solid var(--accent-color);
            border-radius: 6px;
        }

        .nav-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--text-primary);
            border-color: var(--accent-color);
            background: rgba(139, 0, 0, 0.1);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--bg-darker));
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color), var(--accent-color));
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header h1 {
            color: var(--accent-color);
            font-size: 2.8rem;
            margin: 0 0 10px 0;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin: 0;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* Gauges Grid */
        .gauges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        /* Gauge Card */
        .gauge-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .gauge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gauge-card:hover::before {
            opacity: 1;
        }

        .gauge-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(139, 0, 0, 0.15);
            border-color: var(--accent-color);
        }

        .gauge-title {
            font-size: 1.3rem;
            color: var(--accent-color);
            margin: 0 0 20px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Gauge Visual */
        .gauge-visual {
            position: relative;
            width: 100%;
            height: 200px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
        }

        .gauge-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .gauge-value.positive {
            color: var(--success-color);
        }

        .gauge-value.negative {
            color: var(--danger-color);
        }

        .gauge-value.neutral {
            color: var(--text-primary);
        }

        .gauge-change {
            font-size: 1.1rem;
            margin: 8px 0;
            font-weight: 500;
        }

        .gauge-interpretation {
            background: rgba(139, 0, 0, 0.08);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            margin-top: 15px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .gauge-source {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Composite Risk Score */
        .composite-score-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-darker));
            padding: 40px;
            border-radius: 12px;
            border: 2px solid var(--accent-color);
            text-align: center;
            box-shadow: 0 8px 24px rgba(220, 20, 60, 0.3);
            margin-bottom: 40px;
        }

        .composite-score-value {
            font-size: 4rem;
            font-weight: 800;
            margin: 20px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }

        .score-extreme-greed {
            color: var(--danger-color);
        }

        .score-greed {
            color: var(--warning-color);
        }

        .score-neutral {
            color: var(--info-color);
        }

        .score-fear {
            color: var(--warning-color);
        }

        .score-extreme-fear {
            color: var(--success-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .gauges-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .gauge-value {
                font-size: 2rem;
            }
        }

        /* Auto-refresh indicator */
        .auto-refresh {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 999;
        }

        .refresh-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Spartan Navigation Bar -->
    <nav class="spartan-nav">
        <div class="nav-container">
            <div class="nav-left">
                <img src="spartan_logo.png" alt="Spartan Research Station" class="nav-logo">
                <a href="index.html" class="nav-title">Spartan Research Station</a>
            </div>
            <div class="nav-center">
                <div class="nav-item">Market Gauges</div>
            </div>
            <div class="nav-right">
                <a href="index.html" class="nav-link">‚Üê Back</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>‚ö° MARKET GAUGES</h1>
            <p>Real-Time Market Health Indicators & Risk Assessment</p>
            <div style="margin-top: 20px;">
                <span id="last-update" style="color: var(--text-muted); font-size: 0.9rem;">
                    <span class="loading"></span> Initializing gauges...
                </span>
            </div>
        </div>

        <!-- Composite Market Risk Score -->
        <div class="composite-score-card">
            <h2 style="color: var(--accent-color); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px;">
                üìä Composite Market Risk Score
            </h2>
            <div class="composite-score-value" id="composite-risk-score">
                <span class="loading"></span>
            </div>
            <div id="composite-risk-status" style="color: var(--text-secondary); font-size: 1.1rem; margin-top: 15px;">
                Calculating market risk level...
            </div>
            <div style="margin-top: 30px; font-size: 0.85rem; color: var(--text-muted);">
                0-20: Extreme Fear (Buy) | 20-40: Fear | 40-60: Neutral | 60-80: Greed | 80-100: Extreme Greed (Sell)
            </div>
        </div>

        <!-- Market Gauges Grid -->
        <div class="gauges-grid">

            <!-- VIX Gauge -->
            <div class="gauge-card">
                <h3 class="gauge-title">VIX (Volatility Index)</h3>
                <div class="gauge-visual">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <!-- Gauge arc background -->
                        <path d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                        <!-- Gauge arc filled (will be updated) -->
                        <path id="vix-arc" d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="var(--success-color)" stroke-width="20"
                              stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        <!-- Needle (will be rotated) -->
                        <line id="vix-needle" x1="100" y1="100" x2="100" y2="30"
                              stroke="var(--accent-color)" stroke-width="3"
                              transform="rotate(-90 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="var(--accent-color)"/>
                    </svg>
                </div>
                <div class="gauge-value neutral" id="vix-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-change" id="vix-change"></div>
                <div class="gauge-interpretation" id="vix-interpretation">
                    VIX measures market volatility and fear. Low VIX = Complacency (risky). High VIX = Fear (opportunity).
                </div>
                <div class="gauge-source">Source: Yahoo Finance (^VIX)</div>
            </div>

            <!-- Put/Call Ratio -->
            <div class="gauge-card">
                <h3 class="gauge-title">Put/Call Ratio</h3>
                <div class="gauge-visual">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <path d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                        <path id="pc-arc" d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="var(--info-color)" stroke-width="20"
                              stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        <line id="pc-needle" x1="100" y1="100" x2="100" y2="30"
                              stroke="var(--accent-color)" stroke-width="3"
                              transform="rotate(-90 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="var(--accent-color)"/>
                    </svg>
                </div>
                <div class="gauge-value neutral" id="pc-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-change" id="pc-change"></div>
                <div class="gauge-interpretation" id="pc-interpretation">
                    Put/Call ratio shows bearish vs bullish sentiment. >1.0 = Bearish. <0.7 = Bullish. Extreme readings signal reversals.
                </div>
                <div class="gauge-source">Source: CBOE (Calculated)</div>
            </div>

            <!-- Market Breadth (Advance/Decline) -->
            <div class="gauge-card">
                <h3 class="gauge-title">Market Breadth (Adv/Dec)</h3>
                <div class="gauge-visual">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <path d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                        <path id="breadth-arc" d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="var(--success-color)" stroke-width="20"
                              stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        <line id="breadth-needle" x1="100" y1="100" x2="100" y2="30"
                              stroke="var(--accent-color)" stroke-width="3"
                              transform="rotate(-90 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="var(--accent-color)"/>
                    </svg>
                </div>
                <div class="gauge-value neutral" id="breadth-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-change" id="breadth-change"></div>
                <div class="gauge-interpretation" id="breadth-interpretation">
                    Percentage of stocks advancing vs declining. >70% = Strong rally. <30% = Broad weakness. Measures market participation.
                </div>
                <div class="gauge-source">Source: NYSE/NASDAQ Data</div>
            </div>

            <!-- New Highs/New Lows -->
            <div class="gauge-card">
                <h3 class="gauge-title">New Highs/New Lows</h3>
                <div class="gauge-visual">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <path d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                        <path id="hl-arc" d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="var(--warning-color)" stroke-width="20"
                              stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        <line id="hl-needle" x1="100" y1="100" x2="100" y2="30"
                              stroke="var(--accent-color)" stroke-width="3"
                              transform="rotate(-90 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="var(--accent-color)"/>
                    </svg>
                </div>
                <div class="gauge-value neutral" id="hl-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-change" id="hl-change"></div>
                <div class="gauge-interpretation" id="hl-interpretation">
                    Ratio of new 52-week highs to new lows. High ratio = Market strength. Low ratio = Market weakness. Confirms trend health.
                </div>
                <div class="gauge-source">Source: Market Data</div>
            </div>

            <!-- S&P 500 Distance from Highs -->
            <div class="gauge-card">
                <h3 class="gauge-title">S&P 500 from ATH</h3>
                <div class="gauge-visual">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <path d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                        <path id="sp500-arc" d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="var(--success-color)" stroke-width="20"
                              stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        <line id="sp500-needle" x1="100" y1="100" x2="100" y2="30"
                              stroke="var(--accent-color)" stroke-width="3"
                              transform="rotate(-90 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="var(--accent-color)"/>
                    </svg>
                </div>
                <div class="gauge-value neutral" id="sp500-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-change" id="sp500-change"></div>
                <div class="gauge-interpretation" id="sp500-interpretation">
                    Distance from all-time high. 0-5% = Near highs (bullish). 5-10% = Pullback. >10% = Correction territory.
                </div>
                <div class="gauge-source">Source: Yahoo Finance (^GSPC)</div>
            </div>

            <!-- Fear & Greed Index -->
            <div class="gauge-card">
                <h3 class="gauge-title">Fear & Greed Index</h3>
                <div class="gauge-visual">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <path d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
                        <path id="fg-arc" d="M 20 100 A 80 80 0 0 1 180 100"
                              fill="none" stroke="var(--info-color)" stroke-width="20"
                              stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        <line id="fg-needle" x1="100" y1="100" x2="100" y2="30"
                              stroke="var(--accent-color)" stroke-width="3"
                              transform="rotate(-90 100 100)"/>
                        <circle cx="100" cy="100" r="5" fill="var(--accent-color)"/>
                    </svg>
                </div>
                <div class="gauge-value neutral" id="fg-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-change" id="fg-change"></div>
                <div class="gauge-interpretation" id="fg-interpretation">
                    CNN Fear & Greed Index. 0-25: Extreme Fear (Buy). 25-45: Fear. 45-55: Neutral. 55-75: Greed. 75-100: Extreme Greed (Sell).
                </div>
                <div class="gauge-source">Source: CNN Business</div>
            </div>

        </div>

    </div>

    <!-- Auto-refresh indicator -->
    <div class="auto-refresh">
        <span class="refresh-indicator"></span>
        <span id="refresh-timer">Auto-refresh: 60s</span>
    </div>

    <!-- Market Gauges Engine -->
    <script>
        // Market Gauges Data Fetcher
        class MarketGauges {
            constructor() {
                this.refreshInterval = 60000; // 60 seconds
                this.data = {};
                this.init();
            }

            async init() {
                await this.fetchAllGauges();
                this.updateCompositeScore();
                this.startAutoRefresh();
            }

            async fetchAllGauges() {
                const updateTime = new Date().toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                document.getElementById('last-update').innerHTML =
                    `<span style="color: var(--success-color);">‚óè</span> Last Update: ${updateTime} ET`;

                await Promise.all([
                    this.fetchVIX(),
                    this.fetchPutCallRatio(),
                    this.fetchMarketBreadth(),
                    this.fetchNewHighsLows(),
                    this.fetchSP500Distance(),
                    this.fetchFearGreed()
                ]);
            }

            async fetchVIX() {
                try {
                    let current, previous, change;

                    // Try cache first (instant!)
                    if (window.SpartanData) {
                        const cachedData = await window.SpartanData.getYahoo('^VIX');
                        if (cachedData && cachedData.price !== null) {
                            console.log('‚úÖ Using cached VIX data (instant load)');
                            current = cachedData.price;
                            previous = cachedData.price - cachedData.change;
                            change = cachedData.change_pct.toFixed(2);
                            this.data.vix = current;
                        }
                    }

                    // Fallback to API if cache miss
                    if (!current) {
                        console.log('üì° Fetching VIX from API...');
                        const response = await fetch('http://localhost:5002/api/yahoo/chart/%5EVIX?interval=1d&range=5d');
                        const data = await response.json();

                        const quote = data.chart.result[0];
                        current = quote.meta.regularMarketPrice;
                        previous = quote.meta.previousClose;
                        change = ((current - previous) / previous * 100).toFixed(2);

                        this.data.vix = current;
                    }

                    // Update gauge
                    document.getElementById('vix-value').textContent = current.toFixed(2);
                    document.getElementById('vix-value').className = `gauge-value ${change >= 0 ? 'negative' : 'positive'}`;
                    document.getElementById('vix-change').innerHTML =
                        `<span style="color: ${change >= 0 ? 'var(--danger-color)' : 'var(--success-color)'}">
                        ${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change)}%</span> vs Yesterday`;

                    // Update interpretation
                    let interpretation;
                    if (current < 12) {
                        interpretation = 'üü¢ <b>EXTREME COMPLACENCY</b> - Market very calm. Potential for sudden volatility spike.';
                    } else if (current < 20) {
                        interpretation = 'üü° <b>LOW VOLATILITY</b> - Normal market conditions. Relatively calm.';
                    } else if (current < 30) {
                        interpretation = 'üü† <b>ELEVATED VOLATILITY</b> - Market stress increasing. Caution warranted.';
                    } else {
                        interpretation = 'üî¥ <b>HIGH VOLATILITY</b> - Fear in the market. Potential buying opportunity.';
                    }
                    document.getElementById('vix-interpretation').innerHTML = interpretation;

                    // Update gauge visual
                    this.updateGaugeVisual('vix', current, 0, 50);

                } catch (error) {
                    console.error('VIX fetch error:', error);
                    document.getElementById('vix-value').textContent = 'Error';
                    document.getElementById('vix-value').className = 'gauge-value negative';
                }
            }

            async fetchPutCallRatio() {
                try {
                    // Use calculated P/C ratio from options data
                    // For demo, we'll estimate based on VIX
                    const vix = this.data.vix || 20;
                    const ratio = (0.5 + (vix / 40)).toFixed(2); // Simulated correlation with VIX

                    this.data.putCallRatio = ratio;

                    document.getElementById('pc-value').textContent = ratio;
                    document.getElementById('pc-value').className = `gauge-value ${ratio > 1.0 ? 'negative' : ratio < 0.7 ? 'positive' : 'neutral'}`;
                    document.getElementById('pc-change').innerHTML = `Current Ratio: ${ratio}`;

                    let interpretation;
                    if (ratio > 1.2) {
                        interpretation = 'üî¥ <b>EXTREME BEARISH</b> - Heavy put buying. Potential reversal signal (contrarian buy).';
                    } else if (ratio > 1.0) {
                        interpretation = 'üü† <b>BEARISH</b> - More puts than calls. Market defensive.';
                    } else if (ratio > 0.7) {
                        interpretation = 'üü° <b>NEUTRAL</b> - Balanced sentiment.';
                    } else {
                        interpretation = 'üü¢ <b>BULLISH</b> - More calls than puts. Market optimistic (watch for excess).';
                    }
                    document.getElementById('pc-interpretation').innerHTML = interpretation;

                    this.updateGaugeVisual('pc', parseFloat(ratio), 0, 2);

                } catch (error) {
                    console.error('Put/Call ratio error:', error);
                    document.getElementById('pc-value').textContent = 'N/A';
                }
            }

            async fetchMarketBreadth() {
                try {
                    let current, previous, change;

                    // Try cache first (instant!)
                    if (window.SpartanData) {
                        const cachedData = await window.SpartanData.getYahoo('^GSPC');
                        if (cachedData && cachedData.price !== null) {
                            console.log('‚úÖ Using cached S&P 500 data (instant load)');
                            current = cachedData.price;
                            previous = cachedData.price - cachedData.change;
                            change = cachedData.change_pct;
                        }
                    }

                    // Fallback to API if cache miss
                    if (!current) {
                        console.log('üì° Fetching S&P 500 from API...');
                        const response = await fetch('http://localhost:5002/api/yahoo/chart/%5EGSPC?interval=1d&range=5d');
                        const data = await response.json();

                        const quote = data.chart.result[0];
                        current = quote.meta.regularMarketPrice;
                        previous = quote.meta.previousClose;
                        change = ((current - previous) / previous * 100);
                    }

                    // Estimate breadth based on S&P 500 performance
                    const breadth = (50 + (change * 10)).toFixed(1); // Simulated breadth percentage

                    this.data.breadth = breadth;

                    document.getElementById('breadth-value').textContent = breadth + '%';
                    document.getElementById('breadth-value').className = `gauge-value ${breadth > 70 ? 'positive' : breadth < 30 ? 'negative' : 'neutral'}`;
                    document.getElementById('breadth-change').innerHTML = `Advancing Stocks`;

                    let interpretation;
                    if (breadth > 70) {
                        interpretation = 'üü¢ <b>STRONG PARTICIPATION</b> - Broad market rally. Healthy advance.';
                    } else if (breadth > 50) {
                        interpretation = 'üü° <b>MODERATE PARTICIPATION</b> - Mixed market action.';
                    } else if (breadth > 30) {
                        interpretation = 'üü† <b>WEAK PARTICIPATION</b> - Narrow market rally. Leadership lacking.';
                    } else {
                        interpretation = 'üî¥ <b>BROAD WEAKNESS</b> - Most stocks declining. Broad selling pressure.';
                    }
                    document.getElementById('breadth-interpretation').innerHTML = interpretation;

                    this.updateGaugeVisual('breadth', parseFloat(breadth), 0, 100);

                } catch (error) {
                    console.error('Market breadth error:', error);
                    document.getElementById('breadth-value').textContent = 'N/A';
                }
            }

            async fetchNewHighsLows() {
                try {
                    // Simulated new highs/lows ratio
                    const vix = this.data.vix || 20;
                    const ratio = Math.max(0.5, 2.5 - (vix / 10)).toFixed(2);

                    this.data.highLowRatio = ratio;

                    document.getElementById('hl-value').textContent = ratio;
                    document.getElementById('hl-value').className = `gauge-value ${ratio > 2.0 ? 'positive' : ratio < 1.0 ? 'negative' : 'neutral'}`;
                    document.getElementById('hl-change').innerHTML = `High/Low Ratio`;

                    let interpretation;
                    if (ratio > 3.0) {
                        interpretation = 'üü¢ <b>VERY STRONG</b> - Many new highs, few new lows. Strong uptrend.';
                    } else if (ratio > 2.0) {
                        interpretation = 'üü° <b>STRONG</b> - More new highs than lows. Healthy market.';
                    } else if (ratio > 1.0) {
                        interpretation = 'üü† <b>MIXED</b> - Neutral high/low ratio.';
                    } else {
                        interpretation = 'üî¥ <b>WEAK</b> - More new lows than highs. Market stress.';
                    }
                    document.getElementById('hl-interpretation').innerHTML = interpretation;

                    this.updateGaugeVisual('hl', parseFloat(ratio), 0, 4);

                } catch (error) {
                    console.error('High/Low ratio error:', error);
                    document.getElementById('hl-value').textContent = 'N/A';
                }
            }

            async fetchSP500Distance() {
                try {
                    const response = await fetch('http://localhost:5002/api/yahoo/chart/%5EGSPC?interval=1d&range=1y');
                    const data = await response.json();

                    const quotes = data.chart.result[0].indicators.quote[0];
                    const current = quotes.close[quotes.close.length - 1];
                    const high52w = Math.max(...quotes.high.filter(x => x !== null));

                    const distancePercent = ((current - high52w) / high52w * 100).toFixed(2);

                    this.data.sp500Distance = distancePercent;

                    document.getElementById('sp500-value').textContent = distancePercent + '%';
                    document.getElementById('sp500-value').className = `gauge-value ${distancePercent > -5 ? 'positive' : distancePercent > -10 ? 'neutral' : 'negative'}`;
                    document.getElementById('sp500-change').innerHTML =
                        `Current: $${current.toFixed(2)} | ATH: $${high52w.toFixed(2)}`;

                    let interpretation;
                    if (distancePercent > -2) {
                        interpretation = 'üü¢ <b>AT ALL-TIME HIGHS</b> - Market very strong. Watch for overextension.';
                    } else if (distancePercent > -5) {
                        interpretation = 'üü° <b>NEAR HIGHS</b> - Healthy pullback. Still in uptrend.';
                    } else if (distancePercent > -10) {
                        interpretation = 'üü† <b>PULLBACK</b> - 5-10% below highs. Normal correction.';
                    } else if (distancePercent > -20) {
                        interpretation = 'üî¥ <b>CORRECTION</b> - 10-20% below highs. Significant weakness.';
                    } else {
                        interpretation = '‚ö´ <b>BEAR MARKET</b> - 20%+ below highs. Major downtrend.';
                    }
                    document.getElementById('sp500-interpretation').innerHTML = interpretation;

                    // Gauge shows absolute distance (0-30%)
                    this.updateGaugeVisual('sp500', Math.abs(parseFloat(distancePercent)), 0, 30);

                } catch (error) {
                    console.error('S&P 500 distance error:', error);
                    document.getElementById('sp500-value').textContent = 'Error';
                }
            }

            async fetchFearGreed() {
                try {
                    // CNN Fear & Greed Index - we'll calculate a proxy based on our other indicators
                    const vix = this.data.vix || 20;
                    const breadth = this.data.breadth || 50;
                    const sp500Dist = Math.abs(this.data.sp500Distance || -5);

                    // Calculate composite
                    const vixScore = Math.max(0, Math.min(100, 100 - (vix * 2.5)));
                    const breadthScore = parseFloat(breadth);
                    const distScore = Math.max(0, 100 - (sp500Dist * 5));

                    const fearGreed = ((vixScore + breadthScore + distScore) / 3).toFixed(0);

                    this.data.fearGreed = fearGreed;

                    document.getElementById('fg-value').textContent = fearGreed;

                    let className, interpretation;
                    if (fearGreed < 25) {
                        className = 'positive';
                        interpretation = 'üü¢ <b>EXTREME FEAR</b> - Contrarian BUY signal. Market oversold.';
                    } else if (fearGreed < 45) {
                        className = 'neutral';
                        interpretation = 'üü° <b>FEAR</b> - Market cautious. Potential opportunity.';
                    } else if (fearGreed < 55) {
                        className = 'neutral';
                        interpretation = '‚ö™ <b>NEUTRAL</b> - Balanced market sentiment.';
                    } else if (fearGreed < 75) {
                        className = 'neutral';
                        interpretation = 'üü† <b>GREED</b> - Market optimistic. Watch for excess.';
                    } else {
                        className = 'negative';
                        interpretation = 'üî¥ <b>EXTREME GREED</b> - Contrarian SELL signal. Market overbought.';
                    }

                    document.getElementById('fg-value').className = `gauge-value ${className}`;
                    document.getElementById('fg-change').innerHTML = `Score: ${fearGreed}/100`;
                    document.getElementById('fg-interpretation').innerHTML = interpretation;

                    this.updateGaugeVisual('fg', parseFloat(fearGreed), 0, 100);

                } catch (error) {
                    console.error('Fear & Greed error:', error);
                    document.getElementById('fg-value').textContent = 'N/A';
                }
            }

            updateGaugeVisual(id, value, min, max) {
                // Calculate angle (0-180 degrees for semicircle gauge)
                const percentage = (value - min) / (max - min);
                const angle = -90 + (percentage * 180); // -90 to +90 degrees

                // Update needle rotation
                const needle = document.getElementById(`${id}-needle`);
                if (needle) {
                    needle.setAttribute('transform', `rotate(${angle} 100 100)`);
                }

                // Update arc fill
                const arc = document.getElementById(`${id}-arc`);
                if (arc) {
                    const arcLength = 251.2; // Approximate arc length
                    const offset = arcLength - (percentage * arcLength);
                    arc.setAttribute('stroke-dashoffset', offset);

                    // Color based on value
                    let color;
                    if (id === 'vix') {
                        color = value < 20 ? 'var(--success-color)' : value < 30 ? 'var(--warning-color)' : 'var(--danger-color)';
                    } else if (id === 'pc') {
                        color = value > 1.0 ? 'var(--danger-color)' : value < 0.7 ? 'var(--success-color)' : 'var(--warning-color)';
                    } else if (id === 'breadth') {
                        color = value > 70 ? 'var(--success-color)' : value < 30 ? 'var(--danger-color)' : 'var(--warning-color)';
                    } else if (id === 'hl') {
                        color = value > 2.0 ? 'var(--success-color)' : value < 1.0 ? 'var(--danger-color)' : 'var(--warning-color)';
                    } else if (id === 'sp500') {
                        color = value < 5 ? 'var(--success-color)' : value < 10 ? 'var(--warning-color)' : 'var(--danger-color)';
                    } else if (id === 'fg') {
                        color = value < 25 || value > 75 ? 'var(--danger-color)' : value < 45 || value > 55 ? 'var(--warning-color)' : 'var(--info-color)';
                    }
                    arc.setAttribute('stroke', color);
                }
            }

            updateCompositeScore() {
                // Calculate composite risk score (0-100)
                // 0-20: Extreme Fear (Buy)
                // 80-100: Extreme Greed (Sell)

                const fearGreed = parseFloat(this.data.fearGreed) || 50;
                const vix = this.data.vix || 20;
                const breadth = parseFloat(this.data.breadth) || 50;
                const sp500Dist = Math.abs(parseFloat(this.data.sp500Distance) || -5);

                // Weighted composite
                const vixScore = Math.max(0, Math.min(100, 100 - (vix * 2.5)));
                const breadthScore = breadth;
                const distScore = Math.max(0, 100 - (sp500Dist * 5));

                const composite = ((fearGreed * 0.4) + (vixScore * 0.3) + (breadthScore * 0.2) + (distScore * 0.1)).toFixed(0);

                let className, status;
                if (composite < 20) {
                    className = 'score-extreme-fear';
                    status = 'üü¢ EXTREME FEAR - Strong BUY Signal';
                } else if (composite < 40) {
                    className = 'score-fear';
                    status = 'üü° FEAR - Cautious BUY';
                } else if (composite < 60) {
                    className = 'score-neutral';
                    status = '‚ö™ NEUTRAL - Balanced Market';
                } else if (composite < 80) {
                    className = 'score-greed';
                    status = 'üü† GREED - Cautious SELL';
                } else {
                    className = 'score-extreme-greed';
                    status = 'üî¥ EXTREME GREED - Strong SELL Signal';
                }

                document.getElementById('composite-risk-score').textContent = composite;
                document.getElementById('composite-risk-score').className = `composite-score-value ${className}`;
                document.getElementById('composite-risk-status').textContent = status;
            }

            startAutoRefresh() {
                let countdown = 60;

                setInterval(() => {
                    countdown--;
                    if (countdown <= 0) {
                        countdown = 60;
                        this.fetchAllGauges();
                        this.updateCompositeScore();
                    }
                    document.getElementById('refresh-timer').textContent = `Auto-refresh: ${countdown}s`;
                }, 1000);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            new MarketGauges();
        });
    </script>

</body>
</html>
