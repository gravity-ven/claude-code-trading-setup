<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Cache Prevention -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="max-age=0">
    <meta name="last-modified" content="2025-11-18 12:00:00">
    <meta name="build-version" content="v1.0-BAROMETERS-DASHBOARD">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spartan Research Station - Economic Barometers Dashboard</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Spartan Theme -->
    <style>
        :root {
            /* Spartan Color Palette */
            --primary-color: #8B0000;
            --secondary-color: #B22222;
            --accent-color: #DC143C;
            --accent-2-color: #FF5252;
            --accent-3-color: #FF6B6B;
            --bg-dark: #0a1628;
            --bg-darker: #050b14;
            --bg-card: #12203a;
            --text-primary: #ffffff;
            --text-secondary: #b0b8c8;
            --text-muted: #7a8a9a;
            --border-color: #1e3a5f;
            --success-color: #00ff88;
            --warning-color: #ff9500;
            --danger-color: #FF5252;
            --info-color: #0096FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1700px;
            margin: 0 auto;
        }

        /* Spartan Navigation Bar */
        .spartan-nav {
            background: var(--bg-darker);
            border-bottom: 2px solid var(--accent-color);
            padding: 15px 0;
            margin: -20px -20px 30px -20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }

        .nav-container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-logo {
            height: 35px;
            width: auto;
            filter: brightness(1.1);
        }

        .nav-title {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 1.4rem;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        .nav-title:hover {
            color: var(--accent-color);
        }

        .nav-center {
            display: flex;
            align-items: center;
        }

        .nav-item {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 16px;
            border: 1px solid var(--accent-color);
            border-radius: 6px;
        }

        .nav-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--text-primary);
            border-color: var(--accent-color);
            background: rgba(139, 0, 0, 0.1);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--bg-darker));
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color), var(--accent-color));
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header h1 {
            color: var(--accent-color);
            font-size: 2.8rem;
            margin: 0 0 10px 0;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin: 0;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* Barometer Grid */
        .barometer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .barometer-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .barometer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .barometer-card:hover::before {
            opacity: 1;
        }

        .barometer-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(139, 0, 0, 0.15);
            border-color: var(--accent-color);
        }

        .barometer-title {
            font-size: 1.4rem;
            color: var(--accent-color);
            margin: 0 0 25px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        /* Gauge Visualization */
        .gauge-container {
            position: relative;
            width: 280px;
            height: 180px;
            margin: 20px auto;
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
        }

        .gauge-value {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .gauge-label {
            font-size: 1.1rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
        }

        .gauge-status {
            font-size: 1rem;
            text-align: center;
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-excellent {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-good {
            background: rgba(0, 150, 255, 0.2);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        .status-neutral {
            background: rgba(255, 149, 0, 0.2);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .status-poor {
            background: rgba(255, 82, 82, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .metric-details {
            margin-top: 20px;
            padding: 15px;
            background: rgba(139, 0, 0, 0.08);
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 700;
            font-size: 1rem;
        }

        .data-source {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Composite Score Card */
        .composite-score-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-darker));
            padding: 40px;
            border-radius: 12px;
            border: 2px solid var(--accent-color);
            text-align: center;
            box-shadow: 0 8px 24px rgba(220, 20, 60, 0.3);
            margin-bottom: 40px;
        }

        .composite-score-title {
            color: var(--accent-color);
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .composite-score-value {
            font-size: 4rem;
            font-weight: 800;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .barometer-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .gauge-container {
                width: 240px;
                height: 150px;
            }

            .gauge-value {
                font-size: 2.5rem;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .barometer-card {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .barometer-card:nth-child(1) { animation-delay: 0.1s; }
        .barometer-card:nth-child(2) { animation-delay: 0.2s; }
        .barometer-card:nth-child(3) { animation-delay: 0.3s; }
        .barometer-card:nth-child(4) { animation-delay: 0.4s; }
        .barometer-card:nth-child(5) { animation-delay: 0.5s; }
        .barometer-card:nth-child(6) { animation-delay: 0.6s; }
    </style>
</head>
<body>
    <!-- Spartan Navigation Bar -->
    <nav class="spartan-nav">
        <div class="nav-container">
            <div class="nav-left">
                <img src="spartan_logo.png" alt="Spartan Research Station" class="nav-logo">
                <a href="index.html" class="nav-title">Spartan Research Station</a>
            </div>
            <div class="nav-center">
                <div class="nav-item">Economic Barometers</div>
            </div>
            <div class="nav-right">
                <a href="index.html" class="nav-link">‚Üê Back</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>ECONOMIC BAROMETERS</h1>
            <p>Real-Time Economic Sentiment and Leading Indicators Dashboard</p>
            <div style="margin-top: 20px; color: var(--text-muted); font-size: 0.9rem;">
                <span id="last-update">Loading data from FRED API...</span>
            </div>
        </div>

        <!-- Composite Economic Score -->
        <div class="composite-score-card">
            <h2 class="composite-score-title">Composite Economic Health Score</h2>
            <div class="composite-score-value" id="composite-score">
                <span class="loading"></span>
            </div>
            <div id="composite-status" style="color: var(--text-secondary); font-size: 1.2rem; margin-top: 15px;">
                Calculating economic health index...
            </div>
        </div>

        <!-- Barometers Grid -->
        <div class="barometer-grid">
            <!-- Consumer Confidence -->
            <div class="barometer-card">
                <h3 class="barometer-title">Consumer Confidence Index</h3>
                <div class="gauge-container" id="consumer-gauge"></div>
                <div class="gauge-value" id="consumer-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-label">Current Level</div>
                <div class="gauge-status" id="consumer-status">Loading...</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">1-Month Change</span>
                        <span class="detail-value" id="consumer-change-1m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">3-Month Change</span>
                        <span class="detail-value" id="consumer-change-3m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Historical Average</span>
                        <span class="detail-value" id="consumer-avg">--</span>
                    </div>
                </div>
                <div class="data-source">Source: FRED (UMCSENT)</div>
            </div>

            <!-- Business Sentiment (ISM Manufacturing PMI) -->
            <div class="barometer-card">
                <h3 class="barometer-title">Manufacturing PMI</h3>
                <div class="gauge-container" id="manufacturing-gauge"></div>
                <div class="gauge-value" id="manufacturing-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-label">ISM Manufacturing Index</div>
                <div class="gauge-status" id="manufacturing-status">Loading...</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">1-Month Change</span>
                        <span class="detail-value" id="manufacturing-change-1m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Expansion Threshold</span>
                        <span class="detail-value">50.0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Distance from 50</span>
                        <span class="detail-value" id="manufacturing-distance">--</span>
                    </div>
                </div>
                <div class="data-source">Source: FRED (IPMAN - Industrial Production: Manufacturing)</div>
            </div>

            <!-- Services PMI -->
            <div class="barometer-card">
                <h3 class="barometer-title">Services PMI</h3>
                <div class="gauge-container" id="services-gauge"></div>
                <div class="gauge-value" id="services-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-label">ISM Services Index</div>
                <div class="gauge-status" id="services-status">Loading...</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">1-Month Change</span>
                        <span class="detail-value" id="services-change-1m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Expansion Threshold</span>
                        <span class="detail-value">50.0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Sector Weight</span>
                        <span class="detail-value">~70% GDP</span>
                    </div>
                </div>
                <div class="data-source">Source: FRED (PCE - Personal Consumption Expenditures)</div>
            </div>

            <!-- Leading Economic Index -->
            <div class="barometer-card">
                <h3 class="barometer-title">Leading Economic Index</h3>
                <div class="gauge-container" id="lei-gauge"></div>
                <div class="gauge-value" id="lei-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-label">LEI Level</div>
                <div class="gauge-status" id="lei-status">Loading...</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">1-Month Change</span>
                        <span class="detail-value" id="lei-change-1m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">3-Month Change</span>
                        <span class="detail-value" id="lei-change-3m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">6-Month Trend</span>
                        <span class="detail-value" id="lei-trend">--</span>
                    </div>
                </div>
                <div class="data-source">Source: FRED (USSLIND)</div>
            </div>

            <!-- Employment Sentiment -->
            <div class="barometer-card">
                <h3 class="barometer-title">Employment Strength</h3>
                <div class="gauge-container" id="employment-gauge"></div>
                <div class="gauge-value" id="employment-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-label">Initial Claims (Inverted)</div>
                <div class="gauge-status" id="employment-status">Loading...</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">Current Claims</span>
                        <span class="detail-value" id="employment-claims">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">4-Week Average</span>
                        <span class="detail-value" id="employment-avg">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Trend</span>
                        <span class="detail-value" id="employment-trend">--</span>
                    </div>
                </div>
                <div class="data-source">Source: FRED (ICSA)</div>
            </div>

            <!-- Housing Market Sentiment -->
            <div class="barometer-card">
                <h3 class="barometer-title">Housing Market Index</h3>
                <div class="gauge-container" id="housing-gauge"></div>
                <div class="gauge-value" id="housing-value">
                    <span class="loading"></span>
                </div>
                <div class="gauge-label">Builder Confidence</div>
                <div class="gauge-status" id="housing-status">Loading...</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">1-Month Change</span>
                        <span class="detail-value" id="housing-change-1m">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Expansion Threshold</span>
                        <span class="detail-value">50.0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Housing Starts</span>
                        <span class="detail-value" id="housing-starts">--</span>
                    </div>
                </div>
                <div class="data-source">Source: FRED (HOUST)</div>
            </div>
        </div>

    </div>

    <!-- Barometer Data Engine -->
    <script>
        // FRED API Configuration (via local proxy to avoid CORS)
        const FRED_API_KEY = '0a08e7a69f8dbd1b02e19e7af5a82b61';
        const FRED_BASE_URL = 'http://localhost:5002/api/fred/series/observations';

        // Barometer data cache
        const barometerData = {
            consumerConfidence: null,
            manufacturing: null,
            services: null,
            lei: null,
            employment: null,
            housing: null
        };

        // Utility: Fetch FRED data
        async function fetchFREDData(seriesId, limit = 10) {
            // Try cache first (instant!)
            if (window.SpartanData) {
                const cachedObservations = await window.SpartanData.getFred(seriesId);
                if (cachedObservations && cachedObservations.length > 0) {
                    console.log(`‚úÖ Using cached FRED data for ${seriesId} (instant load)`);
                    // Cache stores in descending order, reverse for display
                    return cachedObservations.slice(0, limit).reverse();
                }
            }

            // Fallback to API if cache miss
            console.log(`üì° Fetching FRED ${seriesId} from API...`);
            const url = `${FRED_BASE_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&limit=${limit}&sort_order=desc`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.observations ? data.observations.reverse() : [];
            } catch (error) {
                console.error(`Error fetching ${seriesId}:`, error);
                return [];
            }
        }

        // Utility: Calculate percentage change
        function calcChange(current, previous) {
            if (!current || !previous || previous === '.' || current === '.') return null;
            const curr = parseFloat(current);
            const prev = parseFloat(previous);
            return ((curr - prev) / prev * 100).toFixed(2);
        }

        // Utility: Draw gauge visualization
        function drawGauge(containerId, value, min, max, color) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const normalizedValue = Math.max(min, Math.min(max, value));
            const percentage = ((normalizedValue - min) / (max - min)) * 100;
            const angle = (percentage / 100) * 180 - 90; // -90 to +90 degrees

            // Determine color based on value
            let gaugeColor = color || '#0096FF';
            if (percentage >= 75) gaugeColor = '#00ff88';
            else if (percentage >= 50) gaugeColor = '#0096FF';
            else if (percentage >= 25) gaugeColor = '#ff9500';
            else gaugeColor = '#FF5252';

            const svg = `
                <svg viewBox="0 0 200 120" class="gauge-svg">
                    <!-- Background arc -->
                    <path d="M 20 100 A 80 80 0 0 1 180 100"
                          fill="none"
                          stroke="#1e3a5f"
                          stroke-width="12"
                          stroke-linecap="round"/>

                    <!-- Colored segments -->
                    <path d="M 20 100 A 80 80 0 0 1 65 32"
                          fill="none"
                          stroke="#FF5252"
                          stroke-width="12"
                          stroke-linecap="round"
                          opacity="0.3"/>
                    <path d="M 65 32 A 80 80 0 0 1 100 20"
                          fill="none"
                          stroke="#ff9500"
                          stroke-width="12"
                          stroke-linecap="round"
                          opacity="0.3"/>
                    <path d="M 100 20 A 80 80 0 0 1 135 32"
                          fill="none"
                          stroke="#0096FF"
                          stroke-width="12"
                          stroke-linecap="round"
                          opacity="0.3"/>
                    <path d="M 135 32 A 80 80 0 0 1 180 100"
                          fill="none"
                          stroke="#00ff88"
                          stroke-width="12"
                          stroke-linecap="round"
                          opacity="0.3"/>

                    <!-- Value arc (animated) -->
                    <path d="M 20 100 A 80 80 0 0 1 ${100 + 80 * Math.cos(angle * Math.PI / 180)} ${100 + 80 * Math.sin(angle * Math.PI / 180)}"
                          fill="none"
                          stroke="${gaugeColor}"
                          stroke-width="12"
                          stroke-linecap="round">
                        <animate attributeName="stroke-dasharray"
                                 from="0 1000"
                                 to="1000 0"
                                 dur="1.5s"
                                 fill="freeze"/>
                    </path>

                    <!-- Center dot -->
                    <circle cx="100" cy="100" r="6" fill="${gaugeColor}"/>

                    <!-- Needle -->
                    <line x1="100" y1="100"
                          x2="${100 + 70 * Math.cos(angle * Math.PI / 180)}"
                          y2="${100 + 70 * Math.sin(angle * Math.PI / 180)}"
                          stroke="${gaugeColor}"
                          stroke-width="3"
                          stroke-linecap="round">
                        <animate attributeName="x2"
                                 from="20"
                                 to="${100 + 70 * Math.cos(angle * Math.PI / 180)}"
                                 dur="1.5s"
                                 fill="freeze"/>
                        <animate attributeName="y2"
                                 from="100"
                                 to="${100 + 70 * Math.sin(angle * Math.PI / 180)}"
                                 dur="1.5s"
                                 fill="freeze"/>
                    </line>

                    <!-- Labels -->
                    <text x="20" y="115" fill="#7a8a9a" font-size="10" font-family="Inter">${min}</text>
                    <text x="165" y="115" fill="#7a8a9a" font-size="10" font-family="Inter">${max}</text>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // Utility: Determine status label
        function getStatusLabel(value, thresholds) {
            if (value >= thresholds.excellent) return { label: 'Excellent', class: 'status-excellent' };
            if (value >= thresholds.good) return { label: 'Good', class: 'status-good' };
            if (value >= thresholds.neutral) return { label: 'Neutral', class: 'status-neutral' };
            return { label: 'Poor', class: 'status-poor' };
        }

        // Update Consumer Confidence
        async function updateConsumerConfidence() {
            const data = await fetchFREDData('UMCSENT', 10);
            if (data.length === 0) return;

            const current = parseFloat(data[data.length - 1].value);
            const prev1m = data.length > 1 ? parseFloat(data[data.length - 2].value) : null;
            const prev3m = data.length > 3 ? parseFloat(data[data.length - 4].value) : null;

            // Calculate average
            const values = data.filter(d => d.value !== '.').map(d => parseFloat(d.value));
            const average = values.reduce((a, b) => a + b, 0) / values.length;

            barometerData.consumerConfidence = current;

            // Update UI
            document.getElementById('consumer-value').textContent = current.toFixed(1);
            drawGauge('consumer-gauge', current, 50, 110);

            const status = getStatusLabel(current, { excellent: 95, good: 85, neutral: 75, poor: 0 });
            const statusEl = document.getElementById('consumer-status');
            statusEl.textContent = status.label;
            statusEl.className = 'gauge-status ' + status.class;

            // Details
            if (prev1m) {
                const change1m = calcChange(current, prev1m);
                const el = document.getElementById('consumer-change-1m');
                el.textContent = change1m > 0 ? `+${change1m}%` : `${change1m}%`;
                el.style.color = change1m > 0 ? '#00ff88' : '#FF5252';
            }

            if (prev3m) {
                const change3m = calcChange(current, prev3m);
                const el = document.getElementById('consumer-change-3m');
                el.textContent = change3m > 0 ? `+${change3m}%` : `${change3m}%`;
                el.style.color = change3m > 0 ? '#00ff88' : '#FF5252';
            }

            document.getElementById('consumer-avg').textContent = average.toFixed(1);
        }

        // Update Manufacturing PMI (using Industrial Production as proxy)
        async function updateManufacturing() {
            const data = await fetchFREDData('IPMAN', 10);
            if (data.length === 0) return;

            // Convert Industrial Production index to PMI-like score
            // IP index: 100 = baseline, normalize to PMI scale (35-65)
            const currentRaw = parseFloat(data[data.length - 1].value);
            const prev1m = data.length > 1 ? parseFloat(data[data.length - 2].value) : null;
            const prev3m = data.length > 3 ? parseFloat(data[data.length - 4].value) : null;

            // Calculate 3-month rate of change as PMI proxy
            // Positive growth = >50, negative growth = <50
            let pmiEstimate = 50;
            if (prev3m && prev3m !== 0) {
                const growthRate = ((currentRaw - prev3m) / prev3m) * 100;
                // Map growth rate to PMI: -2% = 42, 0% = 50, +2% = 58
                pmiEstimate = 50 + (growthRate * 4);
                // Clamp to realistic PMI range
                pmiEstimate = Math.max(35, Math.min(65, pmiEstimate));
            }

            barometerData.manufacturing = pmiEstimate;

            document.getElementById('manufacturing-value').textContent = pmiEstimate.toFixed(1);
            drawGauge('manufacturing-gauge', pmiEstimate, 35, 65);

            const statusEl = document.getElementById('manufacturing-status');
            statusEl.textContent = pmiEstimate > 50 ? 'Expanding' : 'Contracting';
            statusEl.className = 'gauge-status ' + (pmiEstimate > 50 ? 'status-good' : 'status-poor');

            const distance = (pmiEstimate - 50).toFixed(1);
            document.getElementById('manufacturing-distance').textContent = distance > 0 ? `+${distance}` : distance;

            if (prev1m && prev1m !== 0) {
                const change = ((currentRaw - prev1m) / prev1m * 100).toFixed(2);
                const el = document.getElementById('manufacturing-change-1m');
                el.textContent = change > 0 ? `+${change}%` : `${change}%`;
                el.style.color = change > 0 ? '#00ff88' : '#FF5252';
            }
        }

        // Update Services PMI (using Personal Consumption Expenditures as proxy)
        async function updateServices() {
            const data = await fetchFREDData('PCE', 10);
            if (data.length === 0) return;

            // Convert PCE growth to PMI-like score
            const currentRaw = parseFloat(data[data.length - 1].value);
            const prev1m = data.length > 1 ? parseFloat(data[data.length - 2].value) : null;
            const prev3m = data.length > 3 ? parseFloat(data[data.length - 4].value) : null;

            // Calculate 3-month annualized growth rate as PMI proxy
            let pmiEstimate = 50;
            if (prev3m && prev3m !== 0) {
                const growthRate = ((currentRaw - prev3m) / prev3m) * 100 * 4; // Annualized
                // Map growth to PMI: 0% = 45, 2% = 50, 4% = 55, 6%+ = 60+
                pmiEstimate = 45 + (growthRate * 2.5);
                // Clamp to realistic services PMI range (typically 45-65)
                pmiEstimate = Math.max(40, Math.min(70, pmiEstimate));
            }

            barometerData.services = pmiEstimate;

            document.getElementById('services-value').textContent = pmiEstimate.toFixed(1);
            drawGauge('services-gauge', pmiEstimate, 40, 70);

            const statusEl = document.getElementById('services-status');
            statusEl.textContent = pmiEstimate > 50 ? 'Expanding' : 'Contracting';
            statusEl.className = 'gauge-status ' + (pmiEstimate > 50 ? 'status-good' : 'status-poor');

            if (prev1m && prev1m !== 0) {
                const change = ((currentRaw - prev1m) / prev1m * 100).toFixed(2);
                const el = document.getElementById('services-change-1m');
                el.textContent = change > 0 ? `+${change}%` : `${change}%`;
                el.style.color = change > 0 ? '#00ff88' : '#FF5252';
            }
        }

        // Update Leading Economic Index
        async function updateLEI() {
            const data = await fetchFREDData('USSLIND', 10);
            if (data.length === 0) return;

            const current = parseFloat(data[data.length - 1].value);
            const prev1m = data.length > 1 ? parseFloat(data[data.length - 2].value) : null;
            const prev3m = data.length > 3 ? parseFloat(data[data.length - 4].value) : null;

            barometerData.lei = current;

            document.getElementById('lei-value').textContent = current.toFixed(1);
            // Use fixed gauge range for LEI (typical range: 95-115)
            drawGauge('lei-gauge', current, 95, 115);

            // Determine trend
            let trendLabel = 'Stable';
            let trendClass = 'status-neutral';
            if (prev3m) {
                const change3m = ((current - prev3m) / prev3m * 100);
                if (change3m > 1) {
                    trendLabel = 'Rising';
                    trendClass = 'status-good';
                } else if (change3m < -1) {
                    trendLabel = 'Falling';
                    trendClass = 'status-poor';
                }
            }

            const statusEl = document.getElementById('lei-status');
            statusEl.textContent = trendLabel;
            statusEl.className = 'gauge-status ' + trendClass;

            if (prev1m) {
                const change1m = calcChange(current, prev1m);
                const el = document.getElementById('lei-change-1m');
                el.textContent = change1m > 0 ? `+${change1m}%` : `${change1m}%`;
                el.style.color = change1m > 0 ? '#00ff88' : '#FF5252';
            }

            if (prev3m) {
                const change3m = calcChange(current, prev3m);
                const el = document.getElementById('lei-change-3m');
                el.textContent = change3m > 0 ? `+${change3m}%` : `${change3m}%`;
                el.style.color = change3m > 0 ? '#00ff88' : '#FF5252';
            }

            document.getElementById('lei-trend').textContent = trendLabel;
        }

        // Update Employment (Initial Claims - inverted for strength)
        async function updateEmployment() {
            const data = await fetchFREDData('ICSA', 10);
            if (data.length === 0) return;

            const currentClaims = parseFloat(data[data.length - 1].value);

            // Calculate 4-week average
            const recentClaims = data.slice(-4).filter(d => d.value !== '.').map(d => parseFloat(d.value));
            const avg4week = recentClaims.reduce((a, b) => a + b, 0) / recentClaims.length;

            // Invert claims to strength score (lower claims = higher strength)
            // Typical range: 200k-600k claims
            // 200k = 100 (excellent), 300k = 75 (good), 400k = 50 (neutral), 500k = 25 (poor), 600k+ = 0 (crisis)
            const minClaims = 200000;
            const maxClaims = 600000;
            const strength = Math.max(0, Math.min(100, 100 * (1 - (currentClaims - minClaims) / (maxClaims - minClaims))));

            barometerData.employment = strength;

            document.getElementById('employment-value').textContent = strength.toFixed(0);
            document.getElementById('employment-claims').textContent = (currentClaims / 1000).toFixed(0) + 'K';
            document.getElementById('employment-avg').textContent = (avg4week / 1000).toFixed(0) + 'K';

            drawGauge('employment-gauge', strength, 0, 100);

            const status = getStatusLabel(strength, { excellent: 75, good: 60, neutral: 40, poor: 0 });
            const statusEl = document.getElementById('employment-status');
            statusEl.textContent = status.label;
            statusEl.className = 'gauge-status ' + status.class;

            // Trend
            const trend = currentClaims < avg4week ? 'Improving' : currentClaims > avg4week ? 'Weakening' : 'Stable';
            const trendEl = document.getElementById('employment-trend');
            trendEl.textContent = trend;
            trendEl.style.color = currentClaims < avg4week ? '#00ff88' : currentClaims > avg4week ? '#FF5252' : '#ff9500';
        }

        // Update Housing
        async function updateHousing() {
            const data = await fetchFREDData('HOUST', 10);
            if (data.length === 0) return;

            const currentStarts = parseFloat(data[data.length - 1].value);
            const prev1m = data.length > 1 ? parseFloat(data[data.length - 2].value) : null;

            // Normalize housing starts to 0-100 scale
            // HOUST data is in thousands: typical range 800K - 1800K annual rate
            // 800K = 0 (crisis), 1200K = 50 (neutral), 1600K = 75 (good), 1800K+ = 100 (excellent)
            const minStarts = 800;
            const maxStarts = 1800;
            const normalized = Math.max(0, Math.min(100, ((currentStarts - minStarts) / (maxStarts - minStarts)) * 100));

            barometerData.housing = normalized;

            document.getElementById('housing-value').textContent = normalized.toFixed(0);
            document.getElementById('housing-starts').textContent = currentStarts.toFixed(0) + 'K';

            drawGauge('housing-gauge', normalized, 0, 100);

            const status = getStatusLabel(normalized, { excellent: 75, good: 60, neutral: 40, poor: 0 });
            const statusEl = document.getElementById('housing-status');
            statusEl.textContent = status.label;
            statusEl.className = 'gauge-status ' + status.class;

            if (prev1m) {
                const change1m = calcChange(currentStarts, prev1m);
                const el = document.getElementById('housing-change-1m');
                el.textContent = change1m > 0 ? `+${change1m}%` : `${change1m}%`;
                el.style.color = change1m > 0 ? '#00ff88' : '#FF5252';
            }
        }

        // Calculate and Update Composite Score
        function updateCompositeScore() {
            const scores = Object.values(barometerData).filter(v => v !== null);
            if (scores.length === 0) return;

            // Normalize all scores to 0-100 scale
            const normalizedScores = [
                barometerData.consumerConfidence ? (barometerData.consumerConfidence - 50) / 60 * 100 : null,
                barometerData.manufacturing ? (barometerData.manufacturing - 35) / 30 * 100 : null, // 35-65 PMI range
                barometerData.services ? (barometerData.services - 40) / 30 * 100 : null, // 40-70 PMI range
                barometerData.lei ? (barometerData.lei - 95) / 20 * 100 : null, // 95-115 LEI range (FIXED!)
                barometerData.employment, // Already 0-100
                barometerData.housing // Already 0-100
            ].filter(v => v !== null);

            const composite = normalizedScores.reduce((a, b) => a + b, 0) / normalizedScores.length;

            const compositeEl = document.getElementById('composite-score');
            compositeEl.textContent = composite.toFixed(0);
            compositeEl.style.color = composite >= 70 ? '#00ff88' : composite >= 50 ? '#0096FF' : composite >= 30 ? '#ff9500' : '#FF5252';

            const statusEl = document.getElementById('composite-status');
            if (composite >= 70) {
                statusEl.textContent = 'Strong Economic Expansion';
                statusEl.style.color = '#00ff88';
            } else if (composite >= 50) {
                statusEl.textContent = 'Moderate Growth';
                statusEl.style.color = '#0096FF';
            } else if (composite >= 30) {
                statusEl.textContent = 'Economic Slowdown';
                statusEl.style.color = '#ff9500';
            } else {
                statusEl.textContent = 'Recessionary Conditions';
                statusEl.style.color = '#FF5252';
            }
        }

        // Initialize Dashboard
        async function initializeDashboard() {
            console.log('Initializing Economic Barometers Dashboard...');

            try {
                await Promise.all([
                    updateConsumerConfidence(),
                    updateManufacturing(),
                    updateServices(),
                    updateLEI(),
                    updateEmployment(),
                    updateHousing()
                ]);

                updateCompositeScore();

                const now = new Date();
                document.getElementById('last-update').textContent = `Last updated: ${now.toLocaleString()}`;

                console.log('Dashboard loaded successfully with real FRED data');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('last-update').textContent = 'Error loading data. Please refresh.';
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(initializeDashboard, 5 * 60 * 1000);

        // Load on page ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }
    </script>
</body>
</html>
