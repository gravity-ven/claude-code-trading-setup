-- =====================================================================
-- Spartan 100 COT Agents - PostgreSQL Schema
-- =====================================================================
-- Database: spartan_research_db (uses existing database)
-- Purpose: Store COT data, agent signals, and trade sheets
-- NO FAKE DATA: All data from CFTC.gov and verified sources
-- =====================================================================

-- Enable UUID extension for unique IDs
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================================
-- TABLE: cot_raw_data
-- Purpose: Store raw CFTC Commitment of Traders reports
-- Source: CFTC.gov (updated weekly)
-- =====================================================================
CREATE TABLE IF NOT EXISTS cot_raw_data (
    id SERIAL PRIMARY KEY,
    report_date DATE NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    cftc_code VARCHAR(20),

    -- Commercial positions
    commercial_long BIGINT,
    commercial_short BIGINT,
    commercial_net BIGINT,

    -- Non-commercial (speculators) positions
    noncommercial_long BIGINT,
    noncommercial_short BIGINT,
    noncommercial_net BIGINT,

    -- Open interest
    open_interest BIGINT,

    -- Metadata
    data_source VARCHAR(50) DEFAULT 'CFTC.gov',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(report_date, symbol)
);

CREATE INDEX idx_cot_raw_symbol_date ON cot_raw_data(symbol, report_date DESC);
CREATE INDEX idx_cot_raw_date ON cot_raw_data(report_date DESC);

-- =====================================================================
-- TABLE: cot_calculated_metrics
-- Purpose: Store calculated COT Index and derived metrics
-- Calculated by: Tier 1 COT Agents (agents 1-30)
-- =====================================================================
CREATE TABLE IF NOT EXISTS cot_calculated_metrics (
    id SERIAL PRIMARY KEY,
    calculation_date DATE NOT NULL,
    symbol VARCHAR(10) NOT NULL,

    -- COT Index (primary signal)
    cot_index DECIMAL(5,2), -- 0.00 to 100.00
    cot_index_26w_min BIGINT,
    cot_index_26w_max BIGINT,

    -- Trend indicators
    cot_trend VARCHAR(20), -- STRONG_BULLISH, BULLISH, NEUTRAL, BEARISH, STRONG_BEARISH
    cot_change_1w DECIMAL(10,4),
    cot_change_4w DECIMAL(10,4),

    -- Extremes
    is_extreme BOOLEAN DEFAULT FALSE,
    extreme_type VARCHAR(20), -- BULLISH_EXTREME, BEARISH_EXTREME

    -- Divergence (COT vs Price)
    price_at_calculation DECIMAL(20,4),
    is_divergence BOOLEAN DEFAULT FALSE,
    divergence_type VARCHAR(20), -- BULLISH_DIVERGENCE, BEARISH_DIVERGENCE

    -- Agent that calculated this
    calculated_by_agent INT, -- Agent ID (1-30)

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(calculation_date, symbol)
);

CREATE INDEX idx_cot_calc_symbol_date ON cot_calculated_metrics(symbol, calculation_date DESC);
CREATE INDEX idx_cot_calc_index ON cot_calculated_metrics(cot_index);
CREATE INDEX idx_cot_calc_extreme ON cot_calculated_metrics(is_extreme) WHERE is_extreme = TRUE;

-- =====================================================================
-- TABLE: seasonal_patterns
-- Purpose: Store seasonality analysis for symbols
-- Calculated by: Tier 2 Seasonal Agents (agents 31-55)
-- =====================================================================
CREATE TABLE IF NOT EXISTS seasonal_patterns (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    pattern_type VARCHAR(50) NOT NULL, -- MONTHLY, PRESIDENTIAL_CYCLE, FOMC, HOLIDAY, COMMODITY_SEASON

    -- Time context
    month INT, -- 1-12 (for monthly patterns)
    year_of_cycle INT, -- 1-4 (for presidential cycle)
    days_before_event INT, -- For FOMC, holidays

    -- Historical performance
    win_rate DECIMAL(5,2), -- Percentage (0-100)
    avg_return DECIMAL(10,4),
    sample_size INT, -- Number of historical occurrences

    -- Current status
    is_active BOOLEAN DEFAULT FALSE, -- Is this pattern active now?
    pattern_start_date DATE,
    pattern_end_date DATE,

    -- Confidence
    confidence_score DECIMAL(5,2), -- 0-100

    -- Agent that calculated this
    calculated_by_agent INT, -- Agent ID (31-55)

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(symbol, pattern_type, month, year_of_cycle, days_before_event)
);

CREATE INDEX idx_seasonal_symbol ON seasonal_patterns(symbol);
CREATE INDEX idx_seasonal_active ON seasonal_patterns(is_active) WHERE is_active = TRUE;
CREATE INDEX idx_seasonal_type ON seasonal_patterns(pattern_type);

-- =====================================================================
-- TABLE: agent_signals
-- Purpose: Store individual agent trade signals
-- Generated by: All 100 agents
-- =====================================================================
CREATE TABLE IF NOT EXISTS agent_signals (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    signal_date TIMESTAMP NOT NULL DEFAULT NOW(),

    -- Agent info
    agent_id INT NOT NULL, -- 1-100
    agent_tier VARCHAR(20) NOT NULL, -- TIER1_COT, TIER2_SEASONAL, TIER3_MODEL, TIER4_RISK
    agent_name VARCHAR(100) NOT NULL,

    -- Symbol and direction
    symbol VARCHAR(10) NOT NULL,
    direction VARCHAR(10) NOT NULL, -- LONG, SHORT, NEUTRAL

    -- Signal strength
    signal_strength DECIMAL(5,2), -- 0-100
    confidence DECIMAL(5,2), -- 0-100

    -- Contributing factors (JSONB for flexibility)
    factors JSONB, -- {cot_index: 95.5, seasonality: "November Rally", etc.}

    -- Trade parameters (if applicable)
    entry_min DECIMAL(20,4),
    entry_max DECIMAL(20,4),
    stop_loss DECIMAL(20,4),
    target_1 DECIMAL(20,4),
    target_2 DECIMAL(20,4),
    target_3 DECIMAL(20,4),

    -- Risk/reward
    risk_reward_ratio DECIMAL(10,2),
    position_size_pct DECIMAL(5,2), -- % of portfolio

    -- Status
    status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE, EXPIRED, FILLED, CANCELLED
    expires_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agent_signals_symbol ON agent_signals(symbol);
CREATE INDEX idx_agent_signals_date ON agent_signals(signal_date DESC);
CREATE INDEX idx_agent_signals_agent ON agent_signals(agent_id);
CREATE INDEX idx_agent_signals_status ON agent_signals(status);
CREATE INDEX idx_agent_signals_active ON agent_signals(status, signal_date DESC) WHERE status = 'ACTIVE';

-- =====================================================================
-- TABLE: confluence_scores
-- Purpose: Store aggregated confluence scores across multiple signals
-- Calculated by: Tier 3 Model Agents (agents 56-80)
-- =====================================================================
CREATE TABLE IF NOT EXISTS confluence_scores (
    id SERIAL PRIMARY KEY,
    score_date TIMESTAMP NOT NULL DEFAULT NOW(),
    symbol VARCHAR(10) NOT NULL,

    -- Overall score
    total_score INT, -- 0-100
    score_grade VARCHAR(2), -- A+, A, B+, B, C+, C, D, F

    -- Component scores
    cot_score INT, -- 0-100
    seasonal_score INT, -- 0-100
    technical_score INT, -- 0-100
    fundamental_score INT, -- 0-100

    -- Signal aggregation
    num_bullish_signals INT,
    num_bearish_signals INT,
    num_neutral_signals INT,
    consensus_direction VARCHAR(10), -- LONG, SHORT, NEUTRAL

    -- Contributing agents
    agent_ids INT[], -- Array of agent IDs that contributed

    -- Trade recommendation
    recommended_action VARCHAR(20), -- STRONG_LONG, LONG, WATCHLIST, SHORT, STRONG_SHORT, AVOID
    priority_rank INT, -- 1 = highest priority

    -- Calculated by
    calculated_by_agent INT, -- Agent ID (56-80)

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(score_date, symbol)
);

CREATE INDEX idx_confluence_symbol_date ON confluence_scores(symbol, score_date DESC);
CREATE INDEX idx_confluence_score ON confluence_scores(total_score DESC);
CREATE INDEX idx_confluence_action ON confluence_scores(recommended_action);

-- =====================================================================
-- TABLE: trade_sheets
-- Purpose: Store generated daily trade sheets
-- Generated by: Tier 4 Risk Agents (agents 81-100)
-- =====================================================================
CREATE TABLE IF NOT EXISTS trade_sheets (
    id SERIAL PRIMARY KEY,
    sheet_date DATE NOT NULL UNIQUE,

    -- Market context
    market_regime VARCHAR(50), -- RISK_ON, RISK_OFF, NEUTRAL
    vix_level DECIMAL(10,2),
    presidential_cycle VARCHAR(50), -- Year 1, Year 2, Year 3, Year 4
    seasonal_phase VARCHAR(100),
    cot_breadth_pct DECIMAL(10,2), -- % of markets with bullish COT

    -- Top opportunities (JSONB arrays)
    top_longs JSONB, -- [{symbol, score, entry, stop, targets}, ...]
    top_shorts JSONB,
    watchlist JSONB,

    -- Generated output (multiple formats)
    sheet_text TEXT, -- Plain text format
    sheet_html TEXT, -- HTML format
    sheet_json JSONB, -- Structured JSON format

    -- Generated by
    generated_by_agent INT, -- Agent ID (81-100)
    generation_time TIMESTAMP DEFAULT NOW(),

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_trade_sheets_date ON trade_sheets(sheet_date DESC);

-- =====================================================================
-- TABLE: agent_performance
-- Purpose: Track individual agent performance over time
-- Updated by: Agent orchestrator
-- =====================================================================
CREATE TABLE IF NOT EXISTS agent_performance (
    id SERIAL PRIMARY KEY,
    agent_id INT NOT NULL UNIQUE,
    agent_name VARCHAR(100) NOT NULL,
    agent_tier VARCHAR(20) NOT NULL,

    -- Signal statistics
    total_signals_generated INT DEFAULT 0,
    signals_last_30d INT DEFAULT 0,

    -- Accuracy (if backtested)
    accuracy_pct DECIMAL(5,2),
    avg_signal_strength DECIMAL(5,2),

    -- Uptime
    last_run_at TIMESTAMP,
    successful_runs INT DEFAULT 0,
    failed_runs INT DEFAULT 0,

    -- Performance metrics
    avg_execution_time_ms INT,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agent_perf_id ON agent_performance(agent_id);
CREATE INDEX idx_agent_perf_tier ON agent_performance(agent_tier);

-- =====================================================================
-- TABLE: system_logs
-- Purpose: Track agent system events and errors
-- =====================================================================
CREATE TABLE IF NOT EXISTS system_logs (
    id SERIAL PRIMARY KEY,
    log_time TIMESTAMP DEFAULT NOW(),
    log_level VARCHAR(10), -- INFO, WARNING, ERROR, CRITICAL

    agent_id INT,
    agent_name VARCHAR(100),

    event_type VARCHAR(50), -- SIGNAL_GENERATED, DATA_FETCHED, ERROR, etc.
    message TEXT,
    details JSONB,

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_system_logs_time ON system_logs(log_time DESC);
CREATE INDEX idx_system_logs_level ON system_logs(log_level);
CREATE INDEX idx_system_logs_agent ON system_logs(agent_id);

-- =====================================================================
-- VIEWS: Convenience views for common queries
-- =====================================================================

-- View: Latest COT signals by symbol
CREATE OR REPLACE VIEW v_latest_cot_signals AS
SELECT
    cm.symbol,
    cm.calculation_date,
    cm.cot_index,
    cm.cot_trend,
    cm.is_extreme,
    cm.extreme_type,
    cm.is_divergence,
    cm.divergence_type,
    cm.price_at_calculation
FROM cot_calculated_metrics cm
INNER JOIN (
    SELECT symbol, MAX(calculation_date) AS max_date
    FROM cot_calculated_metrics
    GROUP BY symbol
) latest ON cm.symbol = latest.symbol AND cm.calculation_date = latest.max_date
ORDER BY cm.cot_index DESC;

-- View: Active trade opportunities
CREATE OR REPLACE VIEW v_active_opportunities AS
SELECT
    cs.symbol,
    cs.total_score,
    cs.score_grade,
    cs.recommended_action,
    cs.priority_rank,
    cs.consensus_direction,
    cs.num_bullish_signals,
    cs.num_bearish_signals,
    cm.cot_index,
    cm.cot_trend
FROM confluence_scores cs
LEFT JOIN cot_calculated_metrics cm ON cs.symbol = cm.symbol
WHERE cs.score_date >= CURRENT_DATE - INTERVAL '1 day'
  AND cs.total_score >= 70
ORDER BY cs.priority_rank;

-- View: Agent health dashboard
CREATE OR REPLACE VIEW v_agent_health AS
SELECT
    ap.agent_id,
    ap.agent_name,
    ap.agent_tier,
    ap.total_signals_generated,
    ap.signals_last_30d,
    ap.accuracy_pct,
    ap.last_run_at,
    CASE
        WHEN ap.last_run_at > NOW() - INTERVAL '1 hour' THEN 'HEALTHY'
        WHEN ap.last_run_at > NOW() - INTERVAL '24 hours' THEN 'WARNING'
        ELSE 'CRITICAL'
    END AS health_status
FROM agent_performance ap
ORDER BY ap.agent_id;

-- =====================================================================
-- FUNCTIONS: Helper functions
-- =====================================================================

-- Function: Calculate COT Index
CREATE OR REPLACE FUNCTION calculate_cot_index(
    p_symbol VARCHAR,
    p_report_date DATE
) RETURNS DECIMAL(5,2) AS $$
DECLARE
    v_current_net BIGINT;
    v_min_net BIGINT;
    v_max_net BIGINT;
    v_cot_index DECIMAL(5,2);
BEGIN
    -- Get current net position
    SELECT commercial_net INTO v_current_net
    FROM cot_raw_data
    WHERE symbol = p_symbol AND report_date = p_report_date;

    -- Get 26-week min/max
    SELECT MIN(commercial_net), MAX(commercial_net)
    INTO v_min_net, v_max_net
    FROM cot_raw_data
    WHERE symbol = p_symbol
      AND report_date >= p_report_date - INTERVAL '26 weeks'
      AND report_date <= p_report_date;

    -- Calculate COT Index
    IF v_max_net = v_min_net THEN
        RETURN 50.0; -- Neutral if no range
    ELSE
        v_cot_index := ((v_current_net - v_min_net)::DECIMAL / (v_max_net - v_min_net)::DECIMAL) * 100;
        RETURN ROUND(v_cot_index, 2);
    END IF;
END;
$$ LANGUAGE plpgsql;

-- Function: Get signal classification
CREATE OR REPLACE FUNCTION get_cot_signal(cot_idx DECIMAL)
RETURNS VARCHAR AS $$
BEGIN
    CASE
        WHEN cot_idx > 95 THEN RETURN 'STRONG_BULLISH';
        WHEN cot_idx > 75 THEN RETURN 'BULLISH';
        WHEN cot_idx > 25 THEN RETURN 'NEUTRAL';
        WHEN cot_idx > 5 THEN RETURN 'BEARISH';
        ELSE RETURN 'STRONG_BEARISH';
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- =====================================================================
-- GRANTS: Permissions
-- =====================================================================

-- Grant permissions to spartan user (existing user from main database)
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO spartan;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO spartan;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO spartan;

-- =====================================================================
-- INITIAL DATA: Agent registry (metadata about all 100 agents)
-- =====================================================================

-- Initialize agent performance tracking
INSERT INTO agent_performance (agent_id, agent_name, agent_tier)
SELECT
    gs.agent_id,
    'Agent_' || gs.agent_id || '_' || gs.tier,
    gs.tier
FROM (
    -- Tier 1: COT Agents (1-30)
    SELECT generate_series(1, 30) AS agent_id, 'TIER1_COT' AS tier
    UNION ALL
    -- Tier 2: Seasonal Agents (31-55)
    SELECT generate_series(31, 55) AS agent_id, 'TIER2_SEASONAL' AS tier
    UNION ALL
    -- Tier 3: Model Agents (56-80)
    SELECT generate_series(56, 80) AS agent_id, 'TIER3_MODEL' AS tier
    UNION ALL
    -- Tier 4: Risk Agents (81-100)
    SELECT generate_series(81, 100) AS agent_id, 'TIER4_RISK' AS tier
) gs
ON CONFLICT (agent_id) DO NOTHING;

-- =====================================================================
-- SUCCESS MESSAGE
-- =====================================================================

DO $$
BEGIN
    RAISE NOTICE 'âœ… Spartan 100 COT Agents schema initialized successfully!';
    RAISE NOTICE 'ðŸ“Š Tables created: 9 (cot_raw_data, cot_calculated_metrics, seasonal_patterns, agent_signals, confluence_scores, trade_sheets, agent_performance, system_logs, and views)';
    RAISE NOTICE 'ðŸ¤– Agent registry: 100 agents initialized';
    RAISE NOTICE 'ðŸŽ¯ Database: spartan_research_db (PostgreSQL 13+)';
    RAISE NOTICE 'ðŸš€ Ready for autonomous COT agent system!';
END $$;
