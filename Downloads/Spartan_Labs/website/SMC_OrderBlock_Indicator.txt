{ SMC OrderBlock Detection Indicator with Multi-Timeframe Analysis
  Author: Spartan Labs
  Version: 1.0
  Description: Advanced institutional order block detection with volume analysis,
               multi-timeframe confirmation, and smart money concept integration
}

inputs:
    // OrderBlock Detection Parameters
    MinOrderBlockSize(0.5),        // Minimum size as % of ATR
    MaxOrderBlockSize(5.0),         // Maximum size as % of ATR
    LookbackBars(50),               // Bars to look back for OB detection
    MinRetouchCount(1),             // Minimum retouches to validate OB
    MaxRetouchCount(3),             // Maximum retouches before OB invalid

    // Volume Analysis Parameters
    VolumeMultiplier(1.5),          // Volume spike threshold
    UseVolumeProfile(true),         // Enable volume profile analysis
    VolumeProfilePeriod(20),        // Period for volume profile
    POCThreshold(0.7),              // Point of Control threshold

    // Multi-Timeframe Settings
    EnableMTF(true),                // Enable multi-timeframe analysis
    HTFMultiplier(4),               // Higher timeframe multiplier
    RequireHTFConfirmation(false),  // Require HTF confirmation

    // Visual Settings
    ShowBullishOB(true),            // Show bullish order blocks
    ShowBearishOB(true),            // Show bearish order blocks
    ShowMitigatedOB(true),          // Show mitigated blocks
    ShowVolumeProfile(false),       // Show volume profile
    ShowPOC(true),                  // Show Point of Control

    // Alert Settings
    AlertOnNewOB(true),             // Alert on new order block
    AlertOnMitigation(true),        // Alert on mitigation
    AlertOnRetouch(false),          // Alert on retouch

    // Color Settings
    BullishOBColor(RGB(0, 255, 0)), // Green for bullish OB
    BearishOBColor(RGB(255, 0, 0)), // Red for bearish OB
    MitigatedOBColor(RGB(128, 128, 128)), // Gray for mitigated
    POCColor(RGB(255, 255, 0)),     // Yellow for POC

    // Risk Management
    ShowTargetZones(true),           // Show profit target zones
    TargetMultiplier(2.0),          // Target as multiple of OB size
    ShowStopZones(true),            // Show stop loss zones
    StopBuffer(0.1);                // Buffer for stop placement (ATR %)

vars:
    // Price and Volume Variables
    CurrentATR(0),
    AvgVolume(0),
    VolumeSpike(false),

    // OrderBlock Detection Variables
    BullishOBHigh(0),
    BullishOBLow(0),
    BearishOBHigh(0),
    BearishOBLow(0),
    BullishOBBar(0),
    BearishOBBar(0),

    // OrderBlock Status
    BullishOBActive(false),
    BearishOBActive(false),
    BullishOBMitigated(false),
    BearishOBMitigated(false),
    BullishRetouchCount(0),
    BearishRetouchCount(0),

    // Volume Profile Variables
    HighestVolume(0),
    POCPrice(0),
    ValueAreaHigh(0),
    ValueAreaLow(0),
    VolumeAtPrice[100](0),
    PriceLevel[100](0),

    // Multi-Timeframe Variables
    HTFBullishOB(false),
    HTFBearishOB(false),
    HTFData(0),

    // Market Structure Variables
    LastSwingHigh(0),
    LastSwingLow(0),
    MarketStructure(0), // 1 = Bullish, -1 = Bearish, 0 = Neutral
    StructureBreak(false),

    // Imbalance Detection
    ImbalanceHigh(0),
    ImbalanceLow(0),
    ImbalanceExists(false),

    // String Variables for Alerts
    AlertMessage("");

Arrays:
    // OrderBlock History Arrays
    BullishOBHighArray[10](0),
    BullishOBLowArray[10](0),
    BullishOBBarArray[10](0),
    BullishOBStatusArray[10](0),

    BearishOBHighArray[10](0),
    BearishOBLowArray[10](0),
    BearishOBBarArray[10](0),
    BearishOBStatusArray[10](0);

// Calculate Current ATR for sizing
CurrentATR = AvgTrueRange(14);
AvgVolume = Average(Volume, 20);

// =============================================================================
// MARKET STRUCTURE ANALYSIS
// =============================================================================

// Detect Swing Points
if High > Highest(High[1], 5) and High > Highest(High, 5)[1] then begin
    LastSwingHigh = High;

    // Check for structure break
    if LastSwingHigh > LastSwingHigh[1] and Low > LastSwingLow then
        MarketStructure = 1; // Bullish structure
end;

if Low < Lowest(Low[1], 5) and Low < Lowest(Low, 5)[1] then begin
    LastSwingLow = Low;

    // Check for structure break
    if LastSwingLow < LastSwingLow[1] and High < LastSwingHigh then
        MarketStructure = -1; // Bearish structure
end;

// Detect Structure Break
StructureBreak = (MarketStructure <> MarketStructure[1]) and MarketStructure[1] <> 0;

// =============================================================================
// VOLUME ANALYSIS
// =============================================================================

// Detect Volume Spike
VolumeSpike = Volume > AvgVolume * VolumeMultiplier;

// Calculate Volume Profile if enabled
if UseVolumeProfile then begin
    Value1 = 0; // Reset counter
    HighestVolume = 0;

    // Calculate volume at each price level
    for Value2 = 0 to VolumeProfilePeriod - 1 begin
        Value3 = Highest(High, VolumeProfilePeriod) - Lowest(Low, VolumeProfilePeriod);
        Value4 = Value3 / 100; // Price increment

        for Value5 = 0 to 99 begin
            PriceLevel[Value5] = Lowest(Low, VolumeProfilePeriod) + (Value5 * Value4);
            VolumeAtPrice[Value5] = 0;

            // Accumulate volume at this price level
            for Value6 = 0 to VolumeProfilePeriod - 1 begin
                if High[Value6] >= PriceLevel[Value5] and Low[Value6] <= PriceLevel[Value5] then
                    VolumeAtPrice[Value5] = VolumeAtPrice[Value5] + Volume[Value6];
            end;

            // Track highest volume level (POC)
            if VolumeAtPrice[Value5] > HighestVolume then begin
                HighestVolume = VolumeAtPrice[Value5];
                POCPrice = PriceLevel[Value5];
            end;
        end;
    end;

    // Calculate Value Area (70% of volume)
    Value7 = 0; // Total volume
    for Value8 = 0 to 99 begin
        Value7 = Value7 + VolumeAtPrice[Value8];
    end;

    Value9 = Value7 * 0.7; // 70% of total volume
    Value10 = 0; // Accumulated volume
    Value11 = 50; // Start from POC index
    Value12 = 50;

    // Find value area boundaries
    while Value10 < Value9 and (Value11 > 0 or Value12 < 99) begin
        if Value11 > 0 then begin
            Value10 = Value10 + VolumeAtPrice[Value11];
            ValueAreaLow = PriceLevel[Value11];
            Value11 = Value11 - 1;
        end;

        if Value12 < 99 and Value10 < Value9 then begin
            Value10 = Value10 + VolumeAtPrice[Value12];
            ValueAreaHigh = PriceLevel[Value12];
            Value12 = Value12 + 1;
        end;
    end;
end;

// =============================================================================
// IMBALANCE (FAIR VALUE GAP) DETECTION
// =============================================================================

// Detect Bullish Imbalance (Fair Value Gap)
if Low > High[2] then begin
    ImbalanceExists = true;
    ImbalanceHigh = Low;
    ImbalanceLow = High[2];
end;

// Detect Bearish Imbalance
if High < Low[2] then begin
    ImbalanceExists = true;
    ImbalanceHigh = Low[2];
    ImbalanceLow = High;
end;

// =============================================================================
// ORDERBLOCK DETECTION LOGIC
// =============================================================================

// Detect Bullish OrderBlock (Last Down Candle before Strong Up Move)
if Close > Open and Close > High[1] and VolumeSpike then begin
    // Look for last bearish candle
    Value13 = 1;
    while Value13 <= LookbackBars and Value13 < MaxBarsBack begin
        if Close[Value13] < Open[Value13] then begin
            // Found potential bullish OB
            Value14 = High[Value13] - Low[Value13]; // OB Size

            // Validate size
            if Value14 >= CurrentATR * MinOrderBlockSize and
               Value14 <= CurrentATR * MaxOrderBlockSize then begin

                // Check if price hasn't returned to this level
                Value15 = true;
                for Value16 = 0 to Value13 - 1 begin
                    if Low[Value16] < High[Value13] then
                        Value15 = false;
                end;

                if Value15 then begin
                    BullishOBHigh = High[Value13];
                    BullishOBLow = Low[Value13];
                    BullishOBBar = BarNumber - Value13;
                    BullishOBActive = true;
                    BullishOBMitigated = false;
                    BullishRetouchCount = 0;

                    // Store in history array
                    for Value17 = 9 downto 1 begin
                        BullishOBHighArray[Value17] = BullishOBHighArray[Value17-1];
                        BullishOBLowArray[Value17] = BullishOBLowArray[Value17-1];
                        BullishOBBarArray[Value17] = BullishOBBarArray[Value17-1];
                        BullishOBStatusArray[Value17] = BullishOBStatusArray[Value17-1];
                    end;

                    BullishOBHighArray[0] = BullishOBHigh;
                    BullishOBLowArray[0] = BullishOBLow;
                    BullishOBBarArray[0] = BullishOBBar;
                    BullishOBStatusArray[0] = 1; // Active

                    Value13 = LookbackBars + 1; // Exit loop
                end;
            end;
        end;
        Value13 = Value13 + 1;
    end;
end;

// Detect Bearish OrderBlock (Last Up Candle before Strong Down Move)
if Close < Open and Close < Low[1] and VolumeSpike then begin
    // Look for last bullish candle
    Value18 = 1;
    while Value18 <= LookbackBars and Value18 < MaxBarsBack begin
        if Close[Value18] > Open[Value18] then begin
            // Found potential bearish OB
            Value19 = High[Value18] - Low[Value18]; // OB Size

            // Validate size
            if Value19 >= CurrentATR * MinOrderBlockSize and
               Value19 <= CurrentATR * MaxOrderBlockSize then begin

                // Check if price hasn't returned to this level
                Value20 = true;
                for Value21 = 0 to Value18 - 1 begin
                    if High[Value21] > Low[Value18] then
                        Value20 = false;
                end;

                if Value20 then begin
                    BearishOBHigh = High[Value18];
                    BearishOBLow = Low[Value18];
                    BearishOBBar = BarNumber - Value18;
                    BearishOBActive = true;
                    BearishOBMitigated = false;
                    BearishRetouchCount = 0;

                    // Store in history array
                    for Value22 = 9 downto 1 begin
                        BearishOBHighArray[Value22] = BearishOBHighArray[Value22-1];
                        BearishOBLowArray[Value22] = BearishOBLowArray[Value22-1];
                        BearishOBBarArray[Value22] = BearishOBBarArray[Value22-1];
                        BearishOBStatusArray[Value22] = BearishOBStatusArray[Value22-1];
                    end;

                    BearishOBHighArray[0] = BearishOBHigh;
                    BearishOBLowArray[0] = BearishOBLow;
                    BearishOBBarArray[0] = BearishOBBar;
                    BearishOBStatusArray[0] = 1; // Active

                    Value18 = LookbackBars + 1; // Exit loop
                end;
            end;
        end;
        Value18 = Value18 + 1;
    end;
end;

// =============================================================================
// ORDERBLOCK MITIGATION AND RETOUCH LOGIC
// =============================================================================

// Check Bullish OrderBlock Status
if BullishOBActive then begin
    // Check for mitigation
    if Close < BullishOBLow then begin
        BullishOBMitigated = true;
        BullishOBActive = false;
        BullishOBStatusArray[0] = 2; // Mitigated

        if AlertOnMitigation then begin
            AlertMessage = "Bullish OrderBlock Mitigated at " + NumToStr(BullishOBLow, 2);
            Alert(AlertMessage);
        end;
    end
    // Check for retouch
    else if Low <= BullishOBHigh and Low >= BullishOBLow then begin
        BullishRetouchCount = BullishRetouchCount + 1;

        if AlertOnRetouch then begin
            AlertMessage = "Bullish OrderBlock Retouched (#" + NumToStr(BullishRetouchCount, 0) + ")";
            Alert(AlertMessage);
        end;

        // Invalidate if too many retouches
        if BullishRetouchCount > MaxRetouchCount then begin
            BullishOBActive = false;
            BullishOBStatusArray[0] = 3; // Invalidated
        end;
    end;
end;

// Check Bearish OrderBlock Status
if BearishOBActive then begin
    // Check for mitigation
    if Close > BearishOBHigh then begin
        BearishOBMitigated = true;
        BearishOBActive = false;
        BearishOBStatusArray[0] = 2; // Mitigated

        if AlertOnMitigation then begin
            AlertMessage = "Bearish OrderBlock Mitigated at " + NumToStr(BearishOBHigh, 2);
            Alert(AlertMessage);
        end;
    end
    // Check for retouch
    else if High >= BearishOBLow and High <= BearishOBHigh then begin
        BearishRetouchCount = BearishRetouchCount + 1;

        if AlertOnRetouch then begin
            AlertMessage = "Bearish OrderBlock Retouched (#" + NumToStr(BearishRetouchCount, 0) + ")";
            Alert(AlertMessage);
        end;

        // Invalidate if too many retouches
        if BearishRetouchCount > MaxRetouchCount then begin
            BearishOBActive = false;
            BearishOBStatusArray[0] = 3; // Invalidated
        end;
    end;
end;

// =============================================================================
// MULTI-TIMEFRAME ANALYSIS
// =============================================================================

if EnableMTF then begin
    // Simulate higher timeframe data
    if Mod(BarNumber, HTFMultiplier) = 0 then begin
        // Calculate HTF values
        Value23 = Highest(High, HTFMultiplier);
        Value24 = Lowest(Low, HTFMultiplier);
        Value25 = Close;
        Value26 = Close[HTFMultiplier];

        // Check for HTF OrderBlocks
        HTFBullishOB = Value25 > Value26 and Value24 > Value24[HTFMultiplier];
        HTFBearishOB = Value25 < Value26 and Value23 < Value23[HTFMultiplier];
    end;

    // Apply HTF confirmation if required
    if RequireHTFConfirmation then begin
        if BullishOBActive and not HTFBullishOB then
            BullishOBActive = false;

        if BearishOBActive and not HTFBearishOB then
            BearishOBActive = false;
    end;
end;

// =============================================================================
// PLOTTING AND VISUALIZATION
// =============================================================================

// Plot Bullish OrderBlocks
if ShowBullishOB and BullishOBActive then begin
    // Draw rectangle for active bullish OB
    Value27 = TL_New(Date[BarNumber - BullishOBBar], Time[BarNumber - BullishOBBar],
                     BullishOBHigh, Date, Time, BullishOBHigh);
    TL_SetColor(Value27, BullishOBColor);
    TL_SetStyle(Value27, 0);
    TL_SetSize(Value27, 2);

    Value28 = TL_New(Date[BarNumber - BullishOBBar], Time[BarNumber - BullishOBBar],
                     BullishOBLow, Date, Time, BullishOBLow);
    TL_SetColor(Value28, BullishOBColor);
    TL_SetStyle(Value28, 0);
    TL_SetSize(Value28, 2);

    // Add text label
    Value29 = Text_New(Date, Time, BullishOBHigh, "Bull OB");
    Text_SetColor(Value29, BullishOBColor);
    Text_SetStyle(Value29, 0, 1);

    // Show target zone if enabled
    if ShowTargetZones then begin
        Value30 = BullishOBHigh - BullishOBLow;
        Value31 = BullishOBHigh + (Value30 * TargetMultiplier);

        Value32 = TL_New(Date, Time, Value31, Date[1], Time[1], Value31);
        TL_SetColor(Value32, Green);
        TL_SetStyle(Value32, 2);

        Value33 = Text_New(Date, Time, Value31, "Target");
        Text_SetColor(Value33, Green);
    end;

    // Show stop zone if enabled
    if ShowStopZones then begin
        Value34 = BullishOBLow - (CurrentATR * StopBuffer);

        Value35 = TL_New(Date, Time, Value34, Date[1], Time[1], Value34);
        TL_SetColor(Value35, Red);
        TL_SetStyle(Value35, 2);

        Value36 = Text_New(Date, Time, Value34, "Stop");
        Text_SetColor(Value36, Red);
    end;
end;

// Plot Bearish OrderBlocks
if ShowBearishOB and BearishOBActive then begin
    // Draw rectangle for active bearish OB
    Value37 = TL_New(Date[BarNumber - BearishOBBar], Time[BarNumber - BearishOBBar],
                     BearishOBHigh, Date, Time, BearishOBHigh);
    TL_SetColor(Value37, BearishOBColor);
    TL_SetStyle(Value37, 0);
    TL_SetSize(Value37, 2);

    Value38 = TL_New(Date[BarNumber - BearishOBBar], Time[BarNumber - BearishOBBar],
                     BearishOBLow, Date, Time, BearishOBLow);
    TL_SetColor(Value38, BearishOBColor);
    TL_SetStyle(Value38, 0);
    TL_SetSize(Value38, 2);

    // Add text label
    Value39 = Text_New(Date, Time, BearishOBLow, "Bear OB");
    Text_SetColor(Value39, BearishOBColor);
    Text_SetStyle(Value39, 0, 1);

    // Show target zone if enabled
    if ShowTargetZones then begin
        Value40 = BearishOBHigh - BearishOBLow;
        Value41 = BearishOBLow - (Value40 * TargetMultiplier);

        Value42 = TL_New(Date, Time, Value41, Date[1], Time[1], Value41);
        TL_SetColor(Value42, Green);
        TL_SetStyle(Value42, 2);

        Value43 = Text_New(Date, Time, Value41, "Target");
        Text_SetColor(Value43, Green);
    end;

    // Show stop zone if enabled
    if ShowStopZones then begin
        Value44 = BearishOBHigh + (CurrentATR * StopBuffer);

        Value45 = TL_New(Date, Time, Value44, Date[1], Time[1], Value44);
        TL_SetColor(Value45, Red);
        TL_SetStyle(Value45, 2);

        Value46 = Text_New(Date, Time, Value44, "Stop");
        Text_SetColor(Value46, Red);
    end;
end;

// Plot Mitigated OrderBlocks
if ShowMitigatedOB then begin
    // Draw mitigated bullish OBs from history
    for Value47 = 0 to 9 begin
        if BullishOBStatusArray[Value47] = 2 then begin // Mitigated
            Value48 = TL_New(Date[BarNumber - BullishOBBarArray[Value47]],
                            Time[BarNumber - BullishOBBarArray[Value47]],
                            BullishOBHighArray[Value47], Date, Time,
                            BullishOBHighArray[Value47]);
            TL_SetColor(Value48, MitigatedOBColor);
            TL_SetStyle(Value48, 1);
        end;
    end;

    // Draw mitigated bearish OBs from history
    for Value49 = 0 to 9 begin
        if BearishOBStatusArray[Value49] = 2 then begin // Mitigated
            Value50 = TL_New(Date[BarNumber - BearishOBBarArray[Value49]],
                            Time[BarNumber - BearishOBBarArray[Value49]],
                            BearishOBLowArray[Value49], Date, Time,
                            BearishOBLowArray[Value49]);
            TL_SetColor(Value50, MitigatedOBColor);
            TL_SetStyle(Value50, 1);
        end;
    end;
end;

// Plot Point of Control
if ShowPOC and UseVolumeProfile and POCPrice > 0 then begin
    Value51 = TL_New(Date[VolumeProfilePeriod], Time[VolumeProfilePeriod],
                     POCPrice, Date, Time, POCPrice);
    TL_SetColor(Value51, POCColor);
    TL_SetStyle(Value51, 0);
    TL_SetSize(Value51, 3);

    Value52 = Text_New(Date, Time, POCPrice, "POC");
    Text_SetColor(Value52, POCColor);
    Text_SetStyle(Value52, 0, 1);
end;

// Plot Imbalances (Fair Value Gaps)
if ImbalanceExists then begin
    Value53 = TL_New(Date[1], Time[1], ImbalanceHigh, Date, Time, ImbalanceHigh);
    TL_SetColor(Value53, Yellow);
    TL_SetStyle(Value53, 3);

    Value54 = TL_New(Date[1], Time[1], ImbalanceLow, Date, Time, ImbalanceLow);
    TL_SetColor(Value54, Yellow);
    TL_SetStyle(Value54, 3);

    Value55 = Text_New(Date, Time, (ImbalanceHigh + ImbalanceLow) * 0.5, "FVG");
    Text_SetColor(Value55, Yellow);
end;

// =============================================================================
// ALERTS
// =============================================================================

// Alert on new OrderBlock formation
if AlertOnNewOB then begin
    if BullishOBActive and BullishOBActive <> BullishOBActive[1] then begin
        AlertMessage = "New Bullish OrderBlock formed at " +
                      NumToStr(BullishOBLow, 2) + "-" + NumToStr(BullishOBHigh, 2);
        Alert(AlertMessage);
    end;

    if BearishOBActive and BearishOBActive <> BearishOBActive[1] then begin
        AlertMessage = "New Bearish OrderBlock formed at " +
                      NumToStr(BearishOBLow, 2) + "-" + NumToStr(BearishOBHigh, 2);
        Alert(AlertMessage);
    end;
end;

// =============================================================================
// INFORMATION DISPLAY
// =============================================================================

// Create info box with current status
if LastBarOnChart then begin
    Value56 = Text_New(Date, Time, Highest(High, 50) * 1.05,
                      "=== SMC OrderBlock Status ===" + NewLine +
                      "Market Structure: " +
                      IFF(MarketStructure = 1, "Bullish",
                          IFF(MarketStructure = -1, "Bearish", "Neutral")) + NewLine +
                      "Active Bull OB: " + IFF(BullishOBActive, "Yes", "No") + NewLine +
                      "Active Bear OB: " + IFF(BearishOBActive, "Yes", "No") + NewLine +
                      "POC Price: " + NumToStr(POCPrice, 2) + NewLine +
                      "Volume Spike: " + IFF(VolumeSpike, "Yes", "No"));
    Text_SetColor(Value56, White);
    Text_SetStyle(Value56, 2, 0);
end;

// =============================================================================
// PLOT OUTPUT SECTION
// =============================================================================

// Plot key levels for reference
Plot1(IFF(BullishOBActive, BullishOBHigh, 0), "Bull OB High");
Plot2(IFF(BullishOBActive, BullishOBLow, 0), "Bull OB Low");
Plot3(IFF(BearishOBActive, BearishOBHigh, 0), "Bear OB High");
Plot4(IFF(BearishOBActive, BearishOBLow, 0), "Bear OB Low");

// Color bars based on OrderBlock proximity
if Close >= BullishOBLow and Close <= BullishOBHigh and BullishOBActive then
    SetPlotColor(1, Green)
else if Close >= BearishOBLow and Close <= BearishOBHigh and BearishOBActive then
    SetPlotColor(1, Red);

// Set plot widths
SetPlotWidth(1, 2);
SetPlotWidth(2, 2);
SetPlotWidth(3, 2);
SetPlotWidth(4, 2);

{ END OF INDICATOR }