<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Cache Prevention -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="max-age=0">
    <meta name="last-modified" content="2025-11-18 00:00:00">
    <meta name="build-version" content="v1.0-HARMONIC-CYCLES">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonic Cycles - Spartan Research Station</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Spartan Theme -->
    <style>
        :root {
            /* Spartan Color Palette */
            --primary-color: #8B0000;
            --secondary-color: #B22222;
            --accent-color: #DC143C;
            --accent-2-color: #FF5252;
            --accent-3-color: #FF6B6B;
            --bg-dark: #0a1628;
            --bg-darker: #050b14;
            --bg-card: #12203a;
            --text-primary: #ffffff;
            --text-secondary: #b0b8c8;
            --text-muted: #7a8a9a;
            --border-color: #1e3a5f;
            --success-color: #00ff88;
            --warning-color: #ff9500;
            --danger-color: #FF5252;
            --info-color: #0096FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1700px;
            margin: 0 auto;
        }

        /* Spartan Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--bg-darker));
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color), var(--accent-color));
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header h1 {
            color: var(--accent-color);
            font-size: 2.8rem;
            margin: 0 0 10px 0;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin: 10px 0;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 30px;
            background: var(--accent-color);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .back-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.4);
        }

        /* Controls Section */
        .controls-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .control-group select,
        .control-group input {
            padding: 12px 15px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.95rem;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--info-color);
        }

        .btn-secondary:hover {
            background: #0077CC;
        }

        /* Pattern Cards Grid */
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .pattern-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .pattern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-2-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pattern-card:hover::before {
            opacity: 1;
        }

        .pattern-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(139, 0, 0, 0.15);
            border-color: var(--accent-color);
        }

        .pattern-title {
            font-size: 1.4rem;
            color: var(--accent-color);
            margin: 0 0 15px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pattern-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(139, 0, 0, 0.08);
            border-radius: 6px;
        }

        .pattern-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .pattern-value {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1rem;
        }

        .pattern-value.bullish {
            color: var(--success-color);
        }

        .pattern-value.bearish {
            color: var(--danger-color);
        }

        /* Chart Cards */
        .chart-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            position: relative;
        }

        .chart-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, transparent 50%, var(--accent-color) 50%);
            border-radius: 0 12px 0 12px;
            opacity: 0.8;
        }

        .chart-title {
            font-size: 1.6rem;
            color: var(--accent-color);
            margin: 0 0 25px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Fibonacci Calculator */
        .fib-calculator {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .fib-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .fib-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .fib-level {
            background: rgba(139, 0, 0, 0.08);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .fib-level-name {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fib-level-value {
            color: var(--accent-color);
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* Pattern Library */
        .pattern-library {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .library-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .library-item h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .library-item ul {
            list-style: none;
            padding: 0;
        }

        .library-item li {
            color: var(--text-secondary);
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        .library-item li:last-child {
            border-bottom: none;
        }

        /* Signal Table */
        .signal-table {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(139, 0, 0, 0.15);
            color: var(--accent-color);
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--accent-color);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        tr:hover {
            background: rgba(139, 0, 0, 0.05);
        }

        .signal-bullish {
            color: var(--success-color);
            font-weight: 700;
        }

        .signal-bearish {
            color: var(--danger-color);
            font-weight: 700;
        }

        /* Status Messages */
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .status-message.info {
            background: rgba(0, 150, 255, 0.1);
            border-left: 4px solid var(--info-color);
            color: var(--info-color);
        }

        .status-message.success {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }

        .status-message.warning {
            background: rgba(255, 149, 0, 0.1);
            border-left: 4px solid var(--warning-color);
            color: var(--warning-color);
        }

        .status-message.error {
            background: rgba(255, 82, 82, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .pattern-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .controls-section {
                grid-template-columns: 1fr;
            }

            .pattern-grid,
            .pattern-library,
            .fib-results {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 300px;
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pattern-card {
            animation: slideIn 0.6s ease-out forwards;
        }

        .pattern-card:nth-child(1) { animation-delay: 0.1s; }
        .pattern-card:nth-child(2) { animation-delay: 0.2s; }
        .pattern-card:nth-child(3) { animation-delay: 0.3s; }
        .pattern-card:nth-child(4) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>Harmonic Cycles Dashboard</h1>
            <p>Advanced Harmonic Pattern Detection & Fibonacci Analysis</p>
            <p style="font-size: 0.95rem; color: var(--text-muted); margin-top: 10px;">
                Real-time pattern scanning with Fibonacci retracements and cycle analysis
            </p>
            <a href="index.html" class="back-btn">‚Üê Back to Dashboard</a>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="control-group">
                <label for="symbol">Symbol</label>
                <input type="text" id="symbol" value="AAPL" placeholder="Enter symbol (e.g., AAPL)">
            </div>
            <div class="control-group">
                <label for="timeframe">Timeframe</label>
                <select id="timeframe">
                    <option value="1d">Daily</option>
                    <option value="1wk">Weekly</option>
                    <option value="1mo">Monthly</option>
                </select>
            </div>
            <div class="control-group">
                <label for="period">Period (Days)</label>
                <input type="number" id="period" value="180" min="30" max="730">
            </div>
            <div class="control-group" style="display: flex; align-items: flex-end;">
                <button class="btn" onclick="scanForPatterns()">
                    <span id="scanBtnText">Scan Patterns</span>
                    <span id="scanBtnSpinner" style="display: none;" class="loading"></span>
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessages"></div>

        <!-- Fibonacci Calculator -->
        <div class="fib-calculator">
            <h2 class="chart-title">Fibonacci Calculator</h2>
            <div class="fib-inputs">
                <div class="control-group">
                    <label for="swingHigh">Swing High</label>
                    <input type="number" id="swingHigh" placeholder="Enter swing high" step="0.01">
                </div>
                <div class="control-group">
                    <label for="swingLow">Swing Low</label>
                    <input type="number" id="swingLow" placeholder="Enter swing low" step="0.01">
                </div>
                <div class="control-group">
                    <label for="direction">Direction</label>
                    <select id="direction">
                        <option value="retracement">Retracement</option>
                        <option value="extension">Extension</option>
                    </select>
                </div>
                <div class="control-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" onclick="calculateFibonacci()">Calculate</button>
                </div>
            </div>
            <div id="fibResults" class="fib-results"></div>
        </div>

        <!-- Main Chart -->
        <div class="chart-card">
            <h2 class="chart-title">Price Chart with Patterns</h2>
            <div class="chart-wrapper">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- Detected Patterns -->
        <div id="patternsSection">
            <h2 class="chart-title" style="margin-bottom: 25px;">Detected Harmonic Patterns</h2>
            <div id="patternsGrid" class="pattern-grid">
                <div class="pattern-card">
                    <div class="pattern-title">No Patterns Detected</div>
                    <p style="color: var(--text-secondary);">Run a pattern scan to detect harmonic setups</p>
                </div>
            </div>
        </div>

        <!-- Cycle Analysis -->
        <div class="chart-card">
            <h2 class="chart-title">Cycle Analysis (FFT)</h2>
            <div class="chart-wrapper">
                <canvas id="cycleChart"></canvas>
            </div>
            <div class="status-message info" style="margin-top: 20px;">
                <span>‚ÑπÔ∏è</span>
                <span>Dominant cycles detected using Fast Fourier Transform on price data</span>
            </div>
        </div>

        <!-- Trading Signals -->
        <div class="signal-table">
            <h2 class="chart-title">Active Trading Signals</h2>
            <table>
                <thead>
                    <tr>
                        <th>Pattern</th>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>Entry</th>
                        <th>Target</th>
                        <th>Stop Loss</th>
                        <th>R:R</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="signalsTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--text-muted);">
                            No active signals. Run pattern scanner to generate signals.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pattern Library -->
        <h2 class="chart-title" style="margin-bottom: 25px;">Harmonic Pattern Library</h2>
        <div class="pattern-library">
            <div class="library-item">
                <h3>Gartley Pattern</h3>
                <ul>
                    <li>XA: Initial impulse move</li>
                    <li>AB: 61.8% retracement of XA</li>
                    <li>BC: 38.2-88.6% retracement of AB</li>
                    <li>CD: 127.2-161.8% extension of BC</li>
                    <li>Target: 61.8% retracement of CD</li>
                </ul>
            </div>
            <div class="library-item">
                <h3>Butterfly Pattern</h3>
                <ul>
                    <li>XA: Initial impulse move</li>
                    <li>AB: 78.6% retracement of XA</li>
                    <li>BC: 38.2-88.6% retracement of AB</li>
                    <li>CD: 161.8-224% extension of XA</li>
                    <li>Target: 61.8% retracement of CD</li>
                </ul>
            </div>
            <div class="library-item">
                <h3>Bat Pattern</h3>
                <ul>
                    <li>XA: Initial impulse move</li>
                    <li>AB: 38.2-50% retracement of XA</li>
                    <li>BC: 38.2-88.6% retracement of AB</li>
                    <li>CD: 88.6% retracement of XA</li>
                    <li>Target: 50% retracement of CD</li>
                </ul>
            </div>
            <div class="library-item">
                <h3>Crab Pattern</h3>
                <ul>
                    <li>XA: Initial impulse move</li>
                    <li>AB: 38.2-61.8% retracement of XA</li>
                    <li>BC: 38.2-88.6% retracement of AB</li>
                    <li>CD: 161.8% extension of XA</li>
                    <li>Target: 61.8% retracement of CD</li>
                </ul>
            </div>
            <div class="library-item">
                <h3>ABCD Pattern</h3>
                <ul>
                    <li>AB: Initial impulse leg</li>
                    <li>BC: Retracement (61.8-78.6%)</li>
                    <li>CD: Extension equal to AB</li>
                    <li>Completion: 127.2-161.8% of BC</li>
                    <li>Target: 61.8% retracement of CD</li>
                </ul>
            </div>
            <div class="library-item">
                <h3>Three Drives Pattern</h3>
                <ul>
                    <li>Drive 1: Initial impulse</li>
                    <li>Drive 2: 61.8-78.6% extension</li>
                    <li>Drive 3: 127.2-161.8% extension</li>
                    <li>Symmetry: Equal time/price ratios</li>
                    <li>Target: Major reversal zone</li>
                </ul>
            </div>
        </div>

        <!-- Footer -->
        <div class="status-message info" style="margin-top: 30px;">
            <span>üìä</span>
            <span>Data Source: Yahoo Finance API (yfinance) ‚Ä¢ Real-time pattern detection using proprietary algorithms ‚Ä¢ Fibonacci calculations based on swing highs/lows</span>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart = null;
        let cycleChart = null;
        let currentData = null;

        // Fibonacci ratios
        const FIB_RATIOS = {
            retracement: [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0],
            extension: [0, 0.618, 1.0, 1.272, 1.414, 1.618, 2.0, 2.618]
        };

        // Pattern definitions with Fibonacci requirements
        const HARMONIC_PATTERNS = {
            gartley: {
                name: 'Gartley',
                ratios: {
                    AB: [0.618, 0.618],
                    BC: [0.382, 0.886],
                    CD_BC: [1.272, 1.618],
                    AD: [0.786, 0.786]
                }
            },
            butterfly: {
                name: 'Butterfly',
                ratios: {
                    AB: [0.786, 0.786],
                    BC: [0.382, 0.886],
                    CD_XA: [1.272, 1.618],
                    AD: [1.27, 1.618]
                }
            },
            bat: {
                name: 'Bat',
                ratios: {
                    AB: [0.382, 0.5],
                    BC: [0.382, 0.886],
                    CD_BC: [1.618, 2.618],
                    AD: [0.886, 0.886]
                }
            },
            crab: {
                name: 'Crab',
                ratios: {
                    AB: [0.382, 0.618],
                    BC: [0.382, 0.886],
                    CD_XA: [2.24, 3.618],
                    AD: [1.618, 1.618]
                }
            }
        };

        // Initialize charts
        function initCharts() {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#b0b8c8'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#1e3a5f'
                        },
                        ticks: {
                            color: '#b0b8c8'
                        }
                    },
                    y: {
                        grid: {
                            color: '#1e3a5f'
                        },
                        ticks: {
                            color: '#b0b8c8'
                        }
                    }
                }
            };

            // Price Chart
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Close Price',
                        data: [],
                        borderColor: '#DC143C',
                        backgroundColor: 'rgba(220, 20, 60, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: chartConfig
            });

            // Cycle Chart
            const cycleCtx = document.getElementById('cycleChart').getContext('2d');
            cycleChart = new Chart(cycleCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cycle Amplitude',
                        data: [],
                        backgroundColor: '#DC143C',
                        borderColor: '#8B0000',
                        borderWidth: 1
                    }]
                },
                options: chartConfig
            });
        }

        // Fetch market data from yfinance via proxy
        async function fetchMarketData(symbol, period, interval) {
            try {
                showStatus('Fetching market data...', 'info');

                // Using yfinance Python backend (requires backend setup)
                // For demo, we'll simulate real data structure
                const response = await fetch(`/api/yfinance?symbol=${symbol}&period=${period}d&interval=${interval}`);

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                showStatus('Error fetching data. Using sample data for demonstration.', 'warning');
                return generateSampleData(symbol, parseInt(period));
            }
        }

        // NO FAKE DATA POLICY: Return empty data instead of synthetic data
        function generateSampleData(symbol, days) {
            console.error(`‚ùå NO DATA AVAILABLE for ${symbol}. API failed and fake data is forbidden.`);
            console.error('Please check API connection or try again later.');
            return {
                symbol: symbol,
                dates: [],
                open: [],
                high: [],
                low: [],
                close: [],
                volume: []
            };
        }

        // Calculate Fibonacci levels
        function calculateFibonacci() {
            const high = parseFloat(document.getElementById('swingHigh').value);
            const low = parseFloat(document.getElementById('swingLow').value);
            const direction = document.getElementById('direction').value;

            if (isNaN(high) || isNaN(low)) {
                showStatus('Please enter valid swing high and low values', 'error');
                return;
            }

            if (high <= low) {
                showStatus('Swing high must be greater than swing low', 'error');
                return;
            }

            const range = high - low;
            const ratios = FIB_RATIOS[direction];
            const resultsDiv = document.getElementById('fibResults');
            resultsDiv.innerHTML = '';

            ratios.forEach(ratio => {
                let level;
                if (direction === 'retracement') {
                    level = high - (range * ratio);
                } else {
                    level = high + (range * ratio);
                }

                const levelDiv = document.createElement('div');
                levelDiv.className = 'fib-level';
                levelDiv.innerHTML = `
                    <div class="fib-level-name">${(ratio * 100).toFixed(1)}%</div>
                    <div class="fib-level-value">$${level.toFixed(2)}</div>
                `;
                resultsDiv.appendChild(levelDiv);
            });

            showStatus(`Fibonacci ${direction} levels calculated successfully`, 'success');
        }

        // Detect swing points
        function findSwingPoints(data, lookback = 5) {
            const swings = {
                highs: [],
                lows: []
            };

            for (let i = lookback; i < data.close.length - lookback; i++) {
                // Check for swing high
                let isHigh = true;
                for (let j = 1; j <= lookback; j++) {
                    if (data.high[i] <= data.high[i - j] || data.high[i] <= data.high[i + j]) {
                        isHigh = false;
                        break;
                    }
                }
                if (isHigh) {
                    swings.highs.push({ index: i, price: data.high[i] });
                }

                // Check for swing low
                let isLow = true;
                for (let j = 1; j <= lookback; j++) {
                    if (data.low[i] >= data.low[i - j] || data.low[i] >= data.low[i + j]) {
                        isLow = false;
                        break;
                    }
                }
                if (isLow) {
                    swings.lows.push({ index: i, price: data.low[i] });
                }
            }

            return swings;
        }

        // Calculate ratio between two points
        function calculateRatio(point1, point2, point3) {
            const move1 = Math.abs(point2 - point1);
            const move2 = Math.abs(point3 - point2);
            return move2 / move1;
        }

        // Check if ratio is within tolerance
        function isRatioValid(actual, expected, tolerance = 0.1) {
            if (Array.isArray(expected)) {
                return actual >= expected[0] - tolerance && actual <= expected[1] + tolerance;
            }
            return Math.abs(actual - expected) <= tolerance;
        }

        // Detect harmonic patterns
        function detectHarmonicPatterns(data) {
            const patterns = [];
            const swings = findSwingPoints(data);

            // Combine swing highs and lows
            const allSwings = [
                ...swings.highs.map(s => ({ ...s, type: 'high' })),
                ...swings.lows.map(s => ({ ...s, type: 'low' }))
            ].sort((a, b) => a.index - b.index);

            // Look for 5-point patterns (X, A, B, C, D)
            for (let i = 0; i < allSwings.length - 4; i++) {
                const X = allSwings[i];
                const A = allSwings[i + 1];
                const B = allSwings[i + 2];
                const C = allSwings[i + 3];
                const D = allSwings[i + 4];

                // Ensure alternating swing types
                if (X.type === A.type || A.type === B.type || B.type === C.type || C.type === D.type) {
                    continue;
                }

                // Determine if bullish or bearish
                const isBullish = X.type === 'low';

                // Calculate ratios
                const XA = Math.abs(A.price - X.price);
                const AB = Math.abs(B.price - A.price);
                const BC = Math.abs(C.price - B.price);
                const CD = Math.abs(D.price - C.price);

                const AB_XA = AB / XA;
                const BC_AB = BC / AB;
                const CD_BC = CD / BC;
                const AD_XA = Math.abs(D.price - A.price) / XA;

                // Check each pattern type
                for (const [key, pattern] of Object.entries(HARMONIC_PATTERNS)) {
                    let isValid = true;

                    if (pattern.ratios.AB) {
                        if (!isRatioValid(AB_XA, pattern.ratios.AB)) isValid = false;
                    }
                    if (pattern.ratios.BC) {
                        if (!isRatioValid(BC_AB, pattern.ratios.BC)) isValid = false;
                    }
                    if (pattern.ratios.CD_BC) {
                        if (!isRatioValid(CD_BC, pattern.ratios.CD_BC)) isValid = false;
                    }
                    if (pattern.ratios.AD) {
                        if (!isRatioValid(AD_XA, pattern.ratios.AD)) isValid = false;
                    }

                    if (isValid) {
                        const entry = D.price;
                        const stop = isBullish ? D.price * 0.98 : D.price * 1.02;
                        const target = isBullish ? D.price + (XA * 0.618) : D.price - (XA * 0.618);
                        const riskReward = Math.abs(target - entry) / Math.abs(entry - stop);

                        patterns.push({
                            type: pattern.name,
                            direction: isBullish ? 'Bullish' : 'Bearish',
                            points: { X, A, B, C, D },
                            entry: entry.toFixed(2),
                            target: target.toFixed(2),
                            stop: stop.toFixed(2),
                            riskReward: riskReward.toFixed(2),
                            completion: ((D.index / data.close.length) * 100).toFixed(1)
                        });
                    }
                }
            }

            return patterns;
        }

        // Perform FFT for cycle detection
        function detectCycles(prices) {
            // Simple FFT approximation for dominant cycles
            const n = prices.length;
            const cycles = [];

            // Test different cycle periods
            for (let period = 5; period <= 60; period++) {
                let amplitude = 0;

                for (let i = 0; i < n - period; i++) {
                    const avg1 = prices.slice(i, i + period).reduce((a, b) => a + b, 0) / period;
                    const avg2 = prices.slice(i + period, Math.min(i + 2 * period, n)).reduce((a, b) => a + b, 0) / Math.min(period, n - i - period);
                    amplitude += Math.abs(avg1 - avg2);
                }

                cycles.push({
                    period: period,
                    amplitude: amplitude / (n - period)
                });
            }

            // Sort by amplitude
            cycles.sort((a, b) => b.amplitude - a.amplitude);
            return cycles.slice(0, 10); // Top 10 cycles
        }

        // Update charts with data
        function updateCharts(data) {
            // Update price chart
            priceChart.data.labels = data.dates;
            priceChart.data.datasets[0].data = data.close;
            priceChart.update();

            // Detect and display cycles
            const cycles = detectCycles(data.close);
            cycleChart.data.labels = cycles.map(c => `${c.period} days`);
            cycleChart.data.datasets[0].data = cycles.map(c => c.amplitude);
            cycleChart.update();
        }

        // Display detected patterns
        function displayPatterns(patterns, symbol) {
            const grid = document.getElementById('patternsGrid');

            if (patterns.length === 0) {
                grid.innerHTML = `
                    <div class="pattern-card">
                        <div class="pattern-title">No Patterns Detected</div>
                        <p style="color: var(--text-secondary);">No valid harmonic patterns found in the current data range. Try a different symbol or timeframe.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = patterns.map(pattern => `
                <div class="pattern-card">
                    <div class="pattern-title">${pattern.type} Pattern</div>
                    <div class="pattern-info">
                        <span class="pattern-label">Direction</span>
                        <span class="pattern-value ${pattern.direction.toLowerCase()}">${pattern.direction}</span>
                    </div>
                    <div class="pattern-info">
                        <span class="pattern-label">Entry</span>
                        <span class="pattern-value">$${pattern.entry}</span>
                    </div>
                    <div class="pattern-info">
                        <span class="pattern-label">Target</span>
                        <span class="pattern-value">$${pattern.target}</span>
                    </div>
                    <div class="pattern-info">
                        <span class="pattern-label">Stop Loss</span>
                        <span class="pattern-value">$${pattern.stop}</span>
                    </div>
                    <div class="pattern-info">
                        <span class="pattern-label">R:R Ratio</span>
                        <span class="pattern-value">${pattern.riskReward}:1</span>
                    </div>
                    <div class="pattern-info">
                        <span class="pattern-label">Completion</span>
                        <span class="pattern-value">${pattern.completion}%</span>
                    </div>
                </div>
            `).join('');

            // Update signals table
            updateSignalsTable(patterns, symbol);
        }

        // Update trading signals table
        function updateSignalsTable(patterns, symbol) {
            const tbody = document.getElementById('signalsTableBody');

            if (patterns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--text-muted);">
                            No active signals detected.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = patterns.map(pattern => `
                <tr>
                    <td>${pattern.type}</td>
                    <td>${symbol}</td>
                    <td class="signal-${pattern.direction.toLowerCase()}">${pattern.direction}</td>
                    <td>$${pattern.entry}</td>
                    <td>$${pattern.target}</td>
                    <td>$${pattern.stop}</td>
                    <td>${pattern.riskReward}:1</td>
                    <td><span style="color: var(--warning-color);">Active</span></td>
                </tr>
            `).join('');
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `status-message ${type}`;

            const icons = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå'
            };

            msgDiv.innerHTML = `
                <span>${icons[type]}</span>
                <span>${message}</span>
            `;

            statusDiv.innerHTML = '';
            statusDiv.appendChild(msgDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                msgDiv.remove();
            }, 5000);
        }

        // Main scan function
        async function scanForPatterns() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            const period = document.getElementById('period').value;
            const timeframe = document.getElementById('timeframe').value;

            if (!symbol) {
                showStatus('Please enter a symbol', 'error');
                return;
            }

            // Show loading state
            const btnText = document.getElementById('scanBtnText');
            const btnSpinner = document.getElementById('scanBtnSpinner');
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';

            try {
                // Fetch market data
                const data = await fetchMarketData(symbol, period, timeframe);
                currentData = data;

                // Update charts
                updateCharts(data);

                // Detect patterns
                const patterns = detectHarmonicPatterns(data);

                // Display results
                displayPatterns(patterns, symbol);

                if (patterns.length > 0) {
                    showStatus(`Found ${patterns.length} harmonic pattern(s) for ${symbol}`, 'success');
                } else {
                    showStatus(`No harmonic patterns detected for ${symbol}`, 'info');
                }

            } catch (error) {
                console.error('Scan error:', error);
                showStatus('Error during pattern scan. Please try again.', 'error');
            } finally {
                // Hide loading state
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            showStatus('Harmonic Cycles Dashboard loaded. Enter a symbol and click "Scan Patterns" to begin.', 'info');

            // Auto-populate Fibonacci calculator with sample values
            document.getElementById('swingHigh').value = '175.50';
            document.getElementById('swingLow').value = '145.20';

            // Run initial scan with default symbol
            scanForPatterns();
        });

        // Allow Enter key to trigger scan
        document.getElementById('symbol').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                scanForPatterns();
            }
        });
    </script>
</body>
</html>
